<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarketLens · Workspaces v7</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary: #172A3A;
      --primary-light: #1e3a4c;
      --accent: #4a9da8;
      --accent-soft: #e8f4f6;
      --accent-hover: #3d8a94;
      --ink: #1f2d3d;
      --muted: #6c7a89;
      --border: #e0e5ea;
      --hair: #eceff3;
      --bg: #f5f6f7;
      --card: #fff;
      --soft: #f8f9fb;
      --success: #4a9d6e;
      --warning: #d4a017;
      --warning-soft: #fef9e8;
      --danger: #c0392b;
      --danger-soft: #fdf0ef;
      --shadow: 0 4px 12px rgba(23,42,58,.08);
      --shadow-lg: 0 8px 24px rgba(23,42,58,.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--ink);
      height: 100vh;
      overflow: hidden;
    }
    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--soft); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    .header {
      background: var(--primary);
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
    }
    .logo-section { display: flex; align-items: center; gap: 10px; }
    .logo { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 12px; }
    .brand-name { color: white; font-size: 17px; font-weight: 600; }
    .header-nav { display: flex; gap: 4px; }
    .nav-tab { padding: 6px 14px; color: rgba(255,255,255,0.65); font-size: 13px; font-weight: 500; border-radius: 6px; cursor: pointer; border: none; background: none; }
    .nav-tab:hover { color: white; background: rgba(255,255,255,0.1); }
    .nav-tab.active { color: white; background: rgba(255,255,255,0.15); }

    .app-container { display: flex; height: calc(100vh - 56px); margin-top: 56px; }

    /* SIDEBAR */
    .sidebar { width: 280px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .sidebar-header { padding: 16px; border-bottom: 1px solid var(--hair); }
    .new-workspace-btn { width: 100%; padding: 10px 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; }
    .new-workspace-btn:hover { background: var(--primary-light); }
    .sidebar-search { position: relative; }
    .sidebar-search input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: var(--soft); }
    .sidebar-search input:focus { outline: none; border-color: var(--accent); }
    .sidebar-search svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); }
    
    .sidebar-content { flex: 1; overflow-y: auto; padding: 8px; }
    .section-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 10px 6px; }
    .workspace-list { display: flex; flex-direction: column; gap: 2px; }
    .workspace-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; position: relative; }
    .workspace-item:hover { background: var(--soft); }
    .workspace-item.active { background: var(--accent-soft); }
    .workspace-icon { width: 32px; height: 32px; background: var(--soft); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); }
    .workspace-item.active .workspace-icon { background: var(--accent); color: white; }
    .workspace-info { flex: 1; min-width: 0; }
    .workspace-name { font-size: 13px; font-weight: 600; color: var(--ink); display: flex; align-items: center; gap: 6px; }
    .workspace-meta { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .pin-icon { color: var(--warning); }
    .activity-dot { width: 6px; height: 6px; background: var(--warning); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    
    .workspace-menu-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: none; background: none; color: var(--muted); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; }
    .workspace-item:hover .workspace-menu-btn { opacity: 1; }
    .workspace-menu-btn:hover { background: var(--border); color: var(--ink); }
    .workspace-menu { position: absolute; right: 0; top: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); min-width: 160px; z-index: 50; display: none; }
    .workspace-menu.open { display: block; }
    .workspace-menu-item { padding: 10px 14px; font-size: 13px; color: var(--ink); cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .workspace-menu-item:hover { background: var(--soft); }
    .workspace-menu-item.danger { color: var(--danger); }
    .workspace-menu-item.danger:hover { background: var(--danger-soft); }
    .menu-divider { height: 1px; background: var(--hair); margin: 4px 0; }

    .quick-links { border-top: 1px solid var(--hair); padding: 12px; }
    .quick-link { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 6px; cursor: pointer; color: var(--muted); font-size: 13px; }
    .quick-link:hover { background: var(--soft); color: var(--ink); }

    /* MAIN */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
    .workspace-header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    .workspace-title { font-size: 18px; font-weight: 600; color: var(--ink); display: flex; align-items: center; gap: 8px; }
    .workspace-actions { display: flex; gap: 8px; }
    .action-btn { padding: 8px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; border: 1px solid var(--border); background: var(--card); color: var(--ink); }
    .action-btn:hover { border-color: var(--accent); color: var(--accent); }
    .action-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
    .action-btn.primary:hover { background: var(--accent-hover); }

    .workspace-body { flex: 1; display: grid; grid-template-columns: 1fr 340px; overflow: hidden; min-height: 0; }
    
    .documents-panel { padding: 20px 24px; overflow-y: auto; min-height: 0; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .panel-title { font-size: 13px; font-weight: 600; color: var(--ink); }
    .panel-count { font-size: 12px; color: var(--muted); }
    .panel-actions { display: flex; gap: 6px; }
    .panel-action-btn { padding: 6px 10px; font-size: 11px; font-weight: 600; color: var(--accent); background: none; border: 1px dashed var(--accent); border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .panel-action-btn:hover { background: var(--accent-soft); }
    .panel-action-btn.solid { border-style: solid; background: var(--accent-soft); }

    /* JOBS TOAST */
    .jobs-toast { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 16px; }
    .jobs-toast-header { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .jobs-toast-header:hover { background: var(--soft); }
    .jobs-toast-title { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--ink); }
    .jobs-badge { background: var(--warning-soft); color: var(--warning); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .jobs-toast-toggle { color: var(--muted); transition: transform 0.2s; }
    .jobs-toast.collapsed .jobs-toast-toggle { transform: rotate(-90deg); }
    .jobs-toast-body { border-top: 1px solid var(--hair); overflow: hidden; }
    .jobs-toast.collapsed .jobs-toast-body { display: none; }
    .job-item { padding: 12px 14px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--hair); }
    .job-item:last-child { border-bottom: none; }
    .job-spinner { width: 18px; height: 18px; border: 2px solid var(--hair); border-left-color: var(--warning); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .job-info { flex: 1; }
    .job-name { font-size: 13px; font-weight: 500; color: var(--ink); }
    .job-progress { font-size: 11px; color: var(--muted); }
    .jobs-empty { padding: 20px; text-align: center; color: var(--muted); font-size: 12px; }

    /* DOCUMENTS */
    .document-list { display: flex; flex-direction: column; gap: 8px; }
    .document-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; cursor: pointer; position: relative; }
    .document-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
    .document-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 6px; }
    .document-type { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--accent); }
    .document-actions { display: flex; gap: 2px; opacity: 0; }
    .document-card:hover .document-actions { opacity: 1; }
    .doc-action-btn { width: 24px; height: 24px; border: none; background: none; color: var(--muted); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .doc-action-btn:hover { background: var(--soft); color: var(--accent); }
    .doc-action-btn.danger:hover { color: var(--danger); background: var(--danger-soft); }
    .document-title { font-size: 14px; font-weight: 600; color: var(--ink); line-height: 1.4; margin-bottom: 4px; }
    .document-meta { font-size: 11px; color: var(--muted); }
    .document-card.is-child { margin-left: 20px; border-left: 3px solid var(--accent); }
    .child-indicator { font-size: 10px; color: var(--muted); margin-bottom: 4px; }

    /* CHAT */
    .chat-panel { background: var(--card); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-height: 0; height: 100%; }
    .chat-header { padding: 12px 16px; border-bottom: 1px solid var(--hair); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .chat-header-left { display: flex; align-items: center; gap: 10px; }
    .chat-header-title { font-size: 13px; font-weight: 600; }
    .chat-usage { font-size: 11px; color: var(--muted); background: var(--soft); padding: 2px 8px; border-radius: 10px; }
    .chat-header-actions { display: flex; gap: 4px; }
    .chat-action-btn { width: 28px; height: 28px; border: none; background: transparent; color: var(--muted); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .chat-action-btn:hover { background: var(--soft); color: var(--ink); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; min-height: 0; }
    .chat-message { margin-bottom: 16px; position: relative; }
    .message-bubble { padding: 10px 14px; font-size: 13px; line-height: 1.5; border-radius: 12px; }
    .chat-message.user .message-bubble { background: var(--primary); color: white; margin-left: 40px; border-bottom-right-radius: 4px; }
    .chat-message.ai .message-bubble { background: var(--soft); color: var(--ink); margin-right: 40px; border-bottom-left-radius: 4px; }
    /* Formatted AI response content */
    .message-bubble p, .doc-chat-bubble p { margin: 0 0 12px 0; }
    .message-bubble p:last-child, .doc-chat-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .doc-chat-bubble strong { font-weight: 600; }
    .message-bubble ul, .doc-chat-bubble ul { margin: 8px 0; padding-left: 20px; }
    .message-bubble li, .doc-chat-bubble li { margin: 4px 0; }
    .message-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; padding: 0 4px; }
    .message-time { font-size: 10px; color: var(--muted); }
    .message-sources { font-size: 10px; color: var(--accent); margin-top: 6px; padding: 0 4px; }
    .message-sources a { color: var(--accent); text-decoration: none; }
    .message-sources a:hover { text-decoration: underline; }
    .message-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
    .chat-message:hover .message-actions { opacity: 1; }
    .msg-action-btn { width: 22px; height: 22px; border: none; background: var(--card); color: var(--muted); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .msg-action-btn:hover { background: var(--soft); color: var(--ink); }
    .chat-welcome { text-align: center; padding: 40px 20px; }
    .chat-welcome-icon { width: 48px; height: 48px; background: var(--soft); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; color: var(--accent); }
    .chat-welcome h3 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .chat-welcome p { font-size: 12px; color: var(--muted); margin-bottom: 20px; }
    .chat-suggestions { display: flex; flex-direction: column; gap: 8px; }
    .chat-suggestion { padding: 10px 14px; background: var(--soft); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; color: var(--ink); cursor: pointer; text-align: left; transition: all 0.15s; }
    .chat-suggestion:hover { border-color: var(--accent); background: white; }
    .chat-input-area { padding: 12px 16px; border-top: 1px solid var(--hair); flex-shrink: 0; background: var(--card); }
    .chat-input-wrapper { display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; resize: none; font-family: inherit; }
    .chat-input:focus { outline: none; border-color: var(--accent); }
    .chat-send-btn { width: 38px; height: 38px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .chat-send-btn:hover { background: var(--accent-hover); }

    /* CHAT HISTORY POPUP */
    .chat-history-popup { position: absolute; top: 100%; right: 0; width: 280px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; box-shadow: var(--shadow-lg); z-index: 100; display: none; margin-top: 8px; }
    .chat-history-popup.open { display: block; }
    .chat-history-header { padding: 12px 14px; border-bottom: 1px solid var(--hair); display: flex; align-items: center; justify-content: space-between; }
    .chat-history-title { font-size: 13px; font-weight: 600; }
    .chat-history-close { width: 24px; height: 24px; border: none; background: none; cursor: pointer; color: var(--muted); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .chat-history-close:hover { background: var(--soft); }
    .chat-history-list { max-height: 300px; overflow-y: auto; }
    .chat-history-empty { padding: 30px 20px; text-align: center; color: var(--muted); font-size: 12px; }
    .chat-history-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--hair); }
    .chat-history-item:hover { background: var(--soft); }
    .chat-history-item.active { background: var(--accent-soft); }
    .chat-history-item:last-child { border-bottom: none; }
    .chat-history-icon { color: var(--muted); flex-shrink: 0; }
    .chat-history-info { flex: 1; min-width: 0; }
    .chat-history-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-history-meta { font-size: 11px; color: var(--muted); }
    .chat-history-actions { display: flex; gap: 2px; opacity: 0; }
    .chat-history-item:hover .chat-history-actions { opacity: 1; }
    .chat-history-action { width: 22px; height: 22px; border: none; background: none; cursor: pointer; color: var(--muted); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .chat-history-action:hover { background: var(--card); color: var(--ink); }
    .chat-history-action.danger:hover { color: var(--danger); }

    /* MODALS */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; visibility: hidden; }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal { background: var(--card); border-radius: 12px; width: 90%; max-width: 480px; max-height: 85vh; overflow: hidden; box-shadow: var(--shadow-lg); }
    .modal.wide { max-width: 540px; }
    .modal.large { max-width: 600px; }
    .modal.fullish { max-width: 800px; }
    .modal-header { padding: 14px 20px 8px; display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { width: 28px; height: 28px; border: none; background: none; cursor: pointer; color: var(--muted); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .modal-close:hover { background: var(--soft); }
    .modal-body { padding: 0 20px 20px; overflow-y: auto; max-height: calc(85vh - 130px); }
    .modal-footer { padding: 14px 20px; border-top: 1px solid var(--hair); display: flex; justify-content: flex-end; gap: 8px; }
    
    .form-group { margin-bottom: 14px; }
    .form-label { display: flex; align-items: center; justify-content: space-between; font-size: 12px; font-weight: 600; color: var(--ink); margin-bottom: 6px; }
    .form-sublabel { font-weight: 400; color: var(--muted); }
    .form-input, .form-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: inherit; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }

    .info-box { background: var(--soft); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 20px; font-size: 13px; line-height: 1.6; }
    .info-box.warning { background: var(--warning-soft); border-color: #f0e6c8; color: #6b5a10; }
    .modal-desc { font-size: 13px; color: var(--muted); margin-bottom: 16px; line-height: 1.5; }
    .form-row { display: flex; gap: 12px; }

    .select-all-btn { font-size: 11px; font-weight: 500; color: var(--accent); background: none; border: none; cursor: pointer; }
    .select-all-btn:hover { text-decoration: underline; }

    /* DOC PICKER */
    .doc-picker { border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; }
    .doc-picker-search { padding: 10px 12px; border-bottom: 1px solid var(--hair); }
    .doc-picker-search input { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; }
    .doc-picker-list { max-height: 50vh; overflow-y: auto; }
    .doc-picker-item { padding: 10px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--hair); cursor: pointer; }
    .doc-picker-item:last-child { border-bottom: none; }
    .doc-picker-item:hover { background: var(--soft); }
    .doc-picker-item.selected { background: var(--accent-soft); }
    .doc-picker-checkbox { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .doc-picker-item.selected .doc-picker-checkbox { background: var(--accent); border-color: var(--accent); color: white; }
    .doc-picker-info { flex: 1; min-width: 0; }
    .doc-picker-title { font-size: 13px; font-weight: 500; color: var(--ink); }
    .doc-picker-meta { font-size: 11px; color: var(--muted); }
    .doc-picker-footer { padding: 10px 12px; border-top: 1px solid var(--hair); background: var(--soft); font-size: 12px; color: var(--muted); }

    /* BATCH RESEARCH */
    .research-types { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .research-type { padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .research-type:hover { background: var(--soft); }
    .research-type.selected { border-color: var(--accent); background: var(--accent-soft); }
    .research-type-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; }
    .research-type.selected .research-type-checkbox { background: var(--accent); border-color: var(--accent); }
    .research-type-info { flex: 1; }
    .research-type-name { font-size: 13px; font-weight: 600; color: var(--ink); }
    .research-type-desc { font-size: 11px; color: var(--muted); }
    .quantity-stepper { display: flex; align-items: center; gap: 2px; opacity: 0.3; pointer-events: none; }
    .research-type.selected .quantity-stepper { opacity: 1; pointer-events: auto; }
    .stepper-btn { width: 26px; height: 26px; border: 1px solid var(--border); background: var(--card); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--muted); }
    .stepper-btn:hover { border-color: var(--accent); color: var(--accent); }
    .stepper-value { width: 32px; text-align: center; font-size: 13px; font-weight: 600; color: var(--ink); }
    .batch-summary { background: var(--soft); border-radius: 8px; padding: 12px 14px; margin-top: 16px; display: flex; align-items: center; justify-content: space-between; }
    .summary-text { font-size: 13px; }
    .summary-text strong { color: var(--accent); }

    .modal-view { display: none; }
    .modal-view.active { display: block; }
    .confirm-box { background: var(--soft); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .confirm-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; }
    .confirm-list { display: flex; flex-direction: column; gap: 8px; }
    .confirm-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--card); border-radius: 6px; font-size: 13px; }
    .confirm-item-name { font-weight: 500; }
    .confirm-item-qty { color: var(--accent); font-weight: 600; }
    .confirm-warning { background: var(--warning-soft); border: 1px solid #f0e6c8; border-radius: 8px; padding: 12px 14px; font-size: 12px; color: #6b5a10; }
    .parent-doc-display { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--accent-soft); border: 1px solid var(--accent); border-radius: 8px; font-size: 13px; color: var(--primary); }
    .parent-doc-display svg { flex-shrink: 0; color: var(--accent); }
    .parent-doc-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .library-list, .pulse-list { display: flex; flex-direction: column; }
    .library-item, .pulse-item { padding: 14px 20px; border-bottom: 1px solid var(--hair); display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .library-item:hover, .pulse-item:hover { background: var(--soft); }
    .library-item-info, .pulse-item-title { flex: 1; }
    .library-item-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
    .library-item-meta { font-size: 12px; color: var(--muted); }
    .library-item-actions { display: flex; gap: 4px; opacity: 0; }
    .library-item:hover .library-item-actions { opacity: 1; }
    .pulse-item-title { font-size: 14px; font-weight: 500; }

    /* ===== DOCUMENT VIEWER ===== */
    dialog#docViewer { width: min(1400px, 98vw); height: min(92vh, 1000px); border: 0; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.28); margin: auto; }
    dialog#docViewer::backdrop { background: rgba(23,42,58,.75); }
    .doc-viewer-head { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: #fff; padding: 10px 14px; position: sticky; top: 0; z-index: 10; }
    .doc-viewer-title { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; margin-right: 16px; }
    .doc-viewer-actions { display: flex; gap: 8px; }
    .doc-viewer-btn { border: 1px solid rgba(255,255,255,0.3); background: transparent; color: rgba(255,255,255,0.8); border-radius: 8px; padding: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; }
    .doc-viewer-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.5); color: white; }
    .doc-viewer-btn.active { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.6); color: white; }
    
    .doc-viewer-container { display: flex; height: calc(100% - 44px); overflow: hidden; }
    .doc-viewer-content { display: flex; flex: 1; gap: 0; overflow: hidden; }
    .doc-viewer-container.chat-open .doc-viewer-content { flex: 0 0 60%; }
    
    /* TOC */
    .doc-toc { width: 220px; background: var(--soft); border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; padding: 20px 0; }
    .doc-toc-header { font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; padding: 0 16px 12px; border-bottom: 2px solid var(--border); margin-bottom: 8px; }
    .doc-toc-list { display: flex; flex-direction: column; gap: 2px; }
    .doc-toc-item { padding: 8px 16px; cursor: pointer; font-size: 12px; color: var(--ink); border-left: 3px solid transparent; transition: all 0.15s; }
    .doc-toc-item:hover { background: rgba(23,42,58,0.05); color: var(--primary); }
    .doc-toc-item.active { background: rgba(23,42,58,0.08); border-left-color: var(--accent); color: var(--primary); font-weight: 600; }
    .doc-toc-item.level-1 { font-weight: 600; }
    .doc-toc-item.level-2 { padding-left: 28px; font-size: 11px; }
    .doc-toc-item.level-3 { padding-left: 40px; font-size: 11px; color: var(--muted); }
    
    /* Document body */
    .doc-body { flex: 1; padding: 30px 50px; overflow-y: auto; background: white; }
    .doc-body h1 { font-size: 26px; color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 12px; margin: 28px 0 18px 0; font-weight: 700; }
    .doc-body h2 { font-size: 20px; color: var(--ink); margin: 24px 0 12px 0; font-weight: 600; border-left: 4px solid var(--accent); padding-left: 14px; }
    .doc-body h3 { font-size: 16px; color: var(--ink); margin: 18px 0 10px 0; font-weight: 600; }
    .doc-body p { margin-bottom: 14px; line-height: 1.7; font-size: 14px; }
    .doc-body strong { color: var(--primary); }
    .doc-body ul, .doc-body ol { margin: 14px 0; padding-left: 24px; }
    .doc-body li { margin-bottom: 6px; font-size: 14px; }
    .doc-body table { width: 100%; border-collapse: collapse; margin: 18px 0; font-size: 13px; background: white; }
    .doc-body th { background: var(--accent) !important; color: white !important; padding: 10px 12px; text-align: left; font-weight: 600; border: 1px solid var(--accent); }
    .doc-body td { border: 1px solid var(--border); padding: 10px 12px; background: white; }
    .doc-body thead { background: var(--accent); }
    .doc-body thead th { background: var(--accent) !important; color: white !important; }
    .doc-body tr:nth-child(even) { background: var(--soft); }
    
    /* Chat/Follow-up panel */
    .doc-chat-panel { width: 0; opacity: 0; overflow: hidden; background: var(--soft); border-left: 1px solid var(--border); display: flex; flex-direction: column; transition: all 0.3s; }
    .doc-viewer-container.chat-open .doc-chat-panel { width: 40%; opacity: 1; }
    .doc-chat-title { padding: 14px 16px; font-size: 14px; font-weight: 700; color: var(--primary); border-bottom: 2px solid var(--border); background: white; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Panel tabs */
    .doc-panel-tabs { display: grid; grid-template-columns: 1fr 1fr; background: var(--soft); border-bottom: 1px solid var(--border); }
    .doc-panel-tab { background: none; border: none; padding: 12px 16px; font-size: 13px; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.15s; text-align: center; }
    .doc-panel-tab:hover { color: var(--ink); background: rgba(255,255,255,0.5); }
    .doc-panel-tab.active { color: var(--primary); border-bottom-color: var(--accent); background: white; }
    
    /* Tab content */
    .doc-tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .doc-tab-content.hidden { display: none; }
    
    /* Chat tab */
    .doc-chat-messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .doc-chat-message { max-width: 85%; }
    .doc-chat-message.user { align-self: flex-end; }
    .doc-chat-message.assistant { align-self: flex-start; }
    .doc-chat-bubble { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
    .doc-chat-message.user .doc-chat-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .doc-chat-message.assistant .doc-chat-bubble { background: white; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .doc-chat-time { font-size: 10px; color: var(--muted); margin-top: 4px; padding: 0 4px; }
    .doc-chat-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--muted); text-align: center; padding: 20px; }
    .doc-chat-empty svg { width: 40px; height: 40px; margin-bottom: 12px; opacity: 0.5; }
    .doc-chat-empty p { font-size: 13px; }
    .doc-chat-input-area { padding: 12px 16px; border-top: 1px solid var(--border); background: white; }
    .doc-chat-input-row { display: flex; gap: 8px; }
    .doc-chat-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; resize: none; font-family: inherit; }
    .doc-chat-input:focus { outline: none; border-color: var(--accent); }
    .doc-chat-send { width: 38px; height: 38px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .doc-chat-send:hover { background: var(--accent-hover); }
    
    /* Follow-up tab */
    .doc-followup-form { padding: 16px; display: flex; flex-direction: column; gap: 14px; height: 100%; overflow-y: auto; }
    .doc-followup-section { display: flex; flex-direction: column; gap: 6px; }
    .doc-followup-label { font-size: 12px; font-weight: 600; color: var(--ink); }
    .doc-followup-context { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; resize: none; font-family: inherit; height: 100px; }
    .doc-followup-context:focus { outline: none; border-color: var(--accent); }
    .doc-followup-context::placeholder { color: var(--muted); font-style: italic; }
    .doc-followup-row { display: flex; gap: 12px; }
    .doc-followup-row .doc-followup-section { flex: 1; }
    .doc-followup-select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 12px; background: white; cursor: pointer; }
    .doc-followup-select:focus { outline: none; border-color: var(--accent); }
    .doc-followup-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: auto; }
    .doc-followup-btn:hover { background: var(--accent-hover); }
    .doc-followup-btn:disabled { background: var(--border); cursor: not-allowed; }

    /* Loading Overlay */
    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; transition: opacity 0.3s; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 14px; color: var(--muted); font-size: 13px; }
    
    /* API Status Badge */
    .api-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 12px; margin-right: 10px; }
    .api-dot { width: 7px; height: 7px; border-radius: 50%; }
    .api-dot.connected { background: #4a9d6e; }
    .api-dot.error { background: #c0392b; }
    .api-dot.loading { background: #d4a017; animation: pulse 1s infinite; }
    
    /* Thinking indicator */
    .thinking-indicator { display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: var(--soft); border-radius: 12px; font-size: 13px; color: var(--muted); }
    .thinking-dots { display: flex; gap: 4px; }
    .thinking-dots span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite; }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting to Vertesia...</div>
  </div>

  <header class="header">
    <div class="logo-section">
      <div class="logo">ML</div>
      <span class="brand-name">MarketLens</span>
    </div>
    <nav class="header-nav">
      <div class="api-status">
        <div class="api-dot loading" id="apiDot"></div>
        <span id="apiStatusText">Connecting...</span>
      </div>
      <button class="nav-tab active">Workspaces</button>
      <button class="nav-tab">Library</button>
      <button class="nav-tab">Pulse</button>
    </nav>
  </header>

  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <button class="new-workspace-btn" onclick="openModal('newWorkspace')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Workspace
        </button>
        <div class="sidebar-search">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="Search workspaces..." oninput="filterWorkspaces(this.value)">
        </div>
      </div>
      <div class="sidebar-content" id="sidebarContent"></div>
      <div class="quick-links">
        <div class="quick-link" onclick="openModal('libraryPopup')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Library
        </div>
        <div class="quick-link" onclick="openModal('pulsePopup')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          Today's Pulse
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="workspace-header">
        <h1 class="workspace-title" id="workspaceTitle">Semiconductor Risk <svg class="pin-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg></h1>
        <div class="workspace-actions">
          <button class="action-btn" onclick="openModal('research')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Research
          </button>
          <button class="action-btn" onclick="openModal('batchResearch')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Batch Research
          </button>
          <button class="action-btn primary" onclick="openModal('generateReport')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Generate Report
          </button>
        </div>
      </div>

      <div class="workspace-body">
        <div class="documents-panel">
          <div class="jobs-toast" id="jobsToast">
            <div class="jobs-toast-header" onclick="toggleJobs()">
              <div class="jobs-toast-title">Research in Progress <span class="jobs-badge" id="jobsBadge">0</span></div>
              <svg class="jobs-toast-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </div>
            <div class="jobs-toast-body" id="jobsBody"></div>
          </div>
          <div class="panel-header">
            <div><span class="panel-title">Documents</span><span class="panel-count" id="docCount"></span></div>
            <div class="panel-actions">
              <button class="panel-action-btn" onclick="openModal('addDocuments')">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add Docs
              </button>
              <button class="panel-action-btn solid" onclick="openModal('findRelated')">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Find Related
              </button>
            </div>
          </div>
          <div class="document-list" id="documentList"></div>
        </div>

        <div class="chat-panel">
          <div class="chat-header" style="position: relative;">
            <div class="chat-header-left">
              <span class="chat-header-title">Workspace Chat</span>
              <span class="chat-usage">3/20</span>
            </div>
            <div class="chat-header-actions">
              <button class="chat-action-btn" onclick="newChat()" title="New Chat">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </button>
              <button class="chat-action-btn" onclick="saveChat()" title="Save Chat">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              </button>
              <button class="chat-action-btn" onclick="toggleChatHistory(event)" title="Chat History">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
              </button>
              <button class="chat-action-btn" onclick="downloadChat()" title="Download">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              </button>
            </div>
            <!-- Chat History Popup -->
            <div class="chat-history-popup" id="chatHistoryPopup">
              <div class="chat-history-header">
                <span class="chat-history-title">Saved Chats</span>
                <button class="chat-history-close" onclick="closeChatHistory()">×</button>
              </div>
              <div class="chat-history-list" id="chatHistoryList">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages">
            <div class="chat-message ai">
              <div class="message-bubble">I've loaded the contents of this workspace. What would you like to explore?</div>
              <div class="message-footer">
                <span class="message-time">Scout · Just now</span>
                <div class="message-actions">
                  <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                </div>
              </div>
            </div>
            <div class="chat-message user">
              <div class="message-bubble">What's the key risk if Taiwan operations are disrupted?</div>
              <div class="message-footer">
                <span class="message-time">You · 2:36 PM</span>
                <div class="message-actions">
                  <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                </div>
              </div>
            </div>
            <div class="chat-message ai">
              <div class="message-bubble">Based on the Ecosystem Mapping doc, <strong>TSMC controls 54% of global advanced foundry capacity</strong>. NVIDIA and Apple are most exposed—they source 85%+ of advanced chips from TSMC.<br><br>The Supply Chain Contagion analysis (generating now) will have specific timeline projections.</div>
              <div class="message-sources">Sources: <a href="#" onclick="event.preventDefault();viewDoc('Semiconductor Ecosystem: TSMC Dependencies')">TSMC Dependencies</a>, <a href="#" onclick="event.preventDefault();viewDoc('Competitive Dynamics: Foundry Market')">Foundry Market Analysis</a></div>
              <div class="message-footer">
                <span class="message-time">Scout · 2:37 PM</span>
                <div class="message-actions">
                  <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                  <button class="msg-action-btn" onclick="quoteMessage(this)" title="Save Quote"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3"/></svg></button>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-input-area">
            <div class="chat-input-wrapper">
              <textarea class="chat-input" id="chatInput" placeholder="Ask about this workspace..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
              <button class="chat-send-btn" onclick="sendChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODALS -->
  <div class="modal-overlay" id="newWorkspace" onclick="if(event.target===this)closeModal('newWorkspace')">
    <div class="modal large">
      <div class="modal-header"><h2 class="modal-title">New Workspace</h2><button class="modal-close" onclick="closeModal('newWorkspace')">×</button></div>
      <div class="modal-body">
        <p class="modal-desc">Workspaces organize related research, enable scoped chat, and generate synthesized reports.</p>
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" class="form-input" id="newWsName" placeholder="e.g., Q1 Portfolio Analysis">
        </div>
        <div class="form-group">
          <label class="form-label">Starting Documents <span class="form-sublabel">(optional)</span></label>
          <div class="doc-picker" id="newWsPicker"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" onclick="closeModal('newWorkspace')">Cancel</button>
        <button class="action-btn primary" onclick="createWorkspace()">Create Workspace</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="addDocuments" onclick="if(event.target===this)closeModal('addDocuments')">
    <div class="modal large">
      <div class="modal-header"><h2 class="modal-title">Add Documents</h2><button class="modal-close" onclick="closeModal('addDocuments')">×</button></div>
      <div class="modal-body">
        <p class="modal-desc">Select documents from your library to add to this workspace.</p>
        <div class="doc-picker" id="addDocsPicker"></div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" onclick="closeModal('addDocuments')">Cancel</button>
        <button class="action-btn primary" onclick="addDocsToWorkspace('addDocsPicker')">Add to Workspace</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="findRelated" onclick="if(event.target===this)closeModal('findRelated')">
    <div class="modal large">
      <div class="modal-header"><h2 class="modal-title">Find Related Documents</h2><button class="modal-close" onclick="closeModal('findRelated')">×</button></div>
      <div class="modal-body">
        <p class="modal-desc">Documents ranked by similarity to your workspace content. Select any to add.</p>
        <div class="doc-picker" id="findRelatedPicker"></div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" onclick="closeModal('findRelated')">Cancel</button>
        <button class="action-btn primary" onclick="addDocsToWorkspace('findRelatedPicker')">Add Selected</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="research" onclick="if(event.target===this)closeModal('research')">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title" id="researchModalTitle">Research</h2><button class="modal-close" onclick="closeModal('research')">×</button></div>
      <div class="modal-body">
        <p class="modal-desc" id="researchModalDesc">Generate a single research document. Output will be added to this workspace.</p>
        <div class="form-group">
          <label class="form-label">Research Type</label>
          <select class="form-select" id="researchType" onchange="updateFocus()">
            <option value="">Select type...</option>
            <option value="traditional">Traditional Analysis</option>
            <option value="ecosystem">Ecosystem Focused</option>
            <option value="scenario">Scenario Modeling</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Focus</label>
          <select class="form-select" id="researchFocus"><option value="">Choose type first...</option></select>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label class="form-label">Scope</label>
            <select class="form-select" id="researchScope">
              <option value="asset">Asset</option>
              <option value="sector">Sector</option>
              <option value="market">Market</option>
            </select>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">Rigor</label>
            <select class="form-select" id="researchRigor">
              <option value="high-level">High Level</option>
              <option value="in-depth">In Depth</option>
              <option value="comprehensive">Comprehensive</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Context <span class="form-sublabel">(optional)</span></label>
          <textarea class="form-input" rows="2" id="researchContext" placeholder="Add any specific focus or context..."></textarea>
        </div>
        <div class="form-group" id="parentDocGroup" style="display:none;">
          <label class="form-label">Parent Document</label>
          <div class="parent-doc-display" id="parentDocDisplay"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" onclick="closeModal('research')">Cancel</button>
        <button class="action-btn primary" id="researchSubmitBtn" onclick="startResearch()">Generate Research</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="batchResearch" onclick="if(event.target===this)closeModal('batchResearch')">
    <div class="modal wide">
      <div class="modal-header"><h2 class="modal-title">Batch Research</h2><button class="modal-close" onclick="closeModal('batchResearch')">×</button></div>
      <div class="modal-view active" id="batchStep1">
        <div class="modal-body">
          <p class="modal-desc">Simultaneously run multiple research queries to build more robust insight.</p>
          <div class="form-group">
            <label class="form-label">Topic</label>
            <textarea class="form-input" rows="2" id="batchTopic" placeholder="e.g., Taiwan disruption impact"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Research Types</label>
            <div class="research-types" id="batchTypes"></div>
          </div>
          <div class="batch-summary"><span class="summary-text"><strong id="batchTotal">0</strong> documents</span><span style="font-size:12px;color:var(--muted)">Runs in parallel</span></div>
        </div>
        <div class="modal-footer">
          <button class="action-btn" onclick="closeModal('batchResearch')">Cancel</button>
          <button class="action-btn primary" onclick="showBatchConfirm()">Review & Confirm</button>
        </div>
      </div>
      <div class="modal-view" id="batchStep2">
        <div class="modal-body">
          <div class="confirm-box"><div class="confirm-title">Research Queue</div><div class="confirm-list" id="confirmList"></div></div>
          <p class="modal-desc" style="color: #6b5a10;"><strong>Note:</strong> This uses significantly more compute. Please confirm.</p>
        </div>
        <div class="modal-footer">
          <button class="action-btn" onclick="showBatchConfig()">Back</button>
          <button class="action-btn primary" onclick="startBatchResearch()">Confirm & Queue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="generateReport" onclick="if(event.target===this)closeModal('generateReport')">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title">Generate Report</h2><button class="modal-close" onclick="closeModal('generateReport')">×</button></div>
      <div class="modal-body">
        <p class="modal-desc">Synthesize your workspace documents into a cohesive report.</p>
        <div class="form-group">
          <label class="form-label">Report Title</label>
          <input type="text" class="form-input" id="reportTitle" value="Semiconductor Supply Chain Risk Report">
        </div>
        <div class="form-group">
          <label class="form-label">Documents <button class="select-all-btn" onclick="toggleAllReportDocs()">Deselect All</button></label>
          <div class="doc-picker" id="reportPicker"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" onclick="closeModal('generateReport')">Cancel</button>
        <button class="action-btn primary" onclick="generateReport()">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="libraryPopup" onclick="if(event.target===this)closeModal('libraryPopup')">
    <div class="modal fullish">
      <div class="modal-header"><h2 class="modal-title">Library</h2><button class="modal-close" onclick="closeModal('libraryPopup')">×</button></div>
      <div class="modal-body" style="padding:0;max-height:500px;overflow-y:auto"><div class="library-list" id="libraryList"></div></div>
    </div>
  </div>

  <div class="modal-overlay" id="pulsePopup" onclick="if(event.target===this)closeModal('pulsePopup')">
    <div class="modal fullish">
      <div class="modal-header"><h2 class="modal-title">Portfolio Pulse - Dec 30, 2025</h2><button class="modal-close" onclick="closeModal('pulsePopup')">×</button></div>
      <div class="modal-body" style="padding:0;max-height:500px;overflow-y:auto"><div class="pulse-list" id="pulseList"></div></div>
    </div>
  </div>

  <!-- Document Viewer Dialog -->
  <dialog id="docViewer">
    <div class="doc-viewer-head">
      <span class="doc-viewer-title" id="docViewerTitle">Document Title</span>
      <div class="doc-viewer-actions">
        <button class="doc-viewer-btn" onclick="downloadDocPDF()" title="Download PDF">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </button>
        <button class="doc-viewer-btn" id="docChatToggle" onclick="toggleDocChat()" title="Chat with Document">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </button>
        <button class="doc-viewer-btn" onclick="closeDocViewer()" title="Close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
    <div class="doc-viewer-container" id="docViewerContainer">
      <div class="doc-viewer-content">
        <div class="doc-toc">
          <div class="doc-toc-header">Contents</div>
          <div class="doc-toc-list" id="docTocList"></div>
        </div>
        <div class="doc-body" id="docBody"></div>
      </div>
      <div class="doc-chat-panel">
        <div class="doc-chat-title" id="docChatTitle">Document Title</div>
        <div class="doc-panel-tabs">
          <button class="doc-panel-tab active" data-tab="chat" onclick="switchDocTab('chat')">Chat with Document</button>
          <button class="doc-panel-tab" data-tab="followup" onclick="switchDocTab('followup')">Follow Up Research</button>
        </div>
        <!-- Chat Tab -->
        <div class="doc-tab-content" id="docChatTab">
          <div class="doc-chat-messages" id="docChatMessages">
            <div class="doc-chat-empty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              <p>Ask questions about this document to get deeper insights</p>
            </div>
          </div>
          <div class="doc-chat-input-area">
            <div class="doc-chat-input-row">
              <textarea class="doc-chat-input" id="docChatInput" placeholder="Ask about this document..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDocChat()}"></textarea>
              <button class="doc-chat-send" onclick="sendDocChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
        </div>
        <!-- Follow Up Tab -->
        <div class="doc-tab-content hidden" id="docFollowupTab">
          <div class="doc-followup-form">
            <div class="doc-followup-section">
              <label class="doc-followup-label">Research Direction</label>
              <textarea class="doc-followup-context" id="docFollowupContext" placeholder="What angle should the follow-up research explore? e.g. 'Deeper analysis of supply chain vulnerabilities' or 'Compare to competitors'"></textarea>
            </div>
            <div class="doc-followup-row">
              <div class="doc-followup-section">
                <label class="doc-followup-label">Scope</label>
                <select class="doc-followup-select" id="docFollowupScope">
                  <option value="asset">Asset</option>
                  <option value="sector">Sector</option>
                  <option value="market">Market</option>
                </select>
              </div>
              <div class="doc-followup-section">
                <label class="doc-followup-label">Rigor</label>
                <select class="doc-followup-select" id="docFollowupRigor">
                  <option value="high-level">High Level</option>
                  <option value="in-depth" selected>In Depth</option>
                  <option value="comprehensive">Comprehensive</option>
                </select>
              </div>
            </div>
            <div class="doc-followup-section">
              <label class="doc-followup-label">Parent Document</label>
              <div class="parent-doc-display" id="viewerParentDocDisplay">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <span class="parent-doc-name" id="viewerParentDocName"></span>
              </div>
            </div>
            <button class="doc-followup-btn" id="docFollowupBtn" onclick="generateFollowUp()">Generate Follow-up Research</button>
          </div>
        </div>
      </div>
    </div>
  </dialog>

<script>
// ===== VERTESIA API CONFIGURATION =====
const VERTESIA_CONFIG = {
  VERTESIA_API_BASE: 'https://api.vertesia.io/api/v1',
  VERTESIA_AUTH_BASE: 'https://api.vertesia.io',
  VERTESIA_API_KEY: 'sk-2538a58567e4ebb6654c0a17ceab228c',
  ENVIRONMENT_ID: '681915c6a01fb262a410c161',
  MODEL: 'publishers/anthropic/models/claude-sonnet-4',
  INTERACTION_RESEARCH: 'ResearchV2',
  INTERACTION_CHAT: 'DocumentChat'
};

// ===== VERTESIA API CLASS =====
class VertesiaAPI {
  constructor() {
    this.jwtToken = null;
    this.tokenExpiry = null;
  }

  // Get JWT token from API key
  async getAuthToken() {
    // Return cached token if still valid (tokens typically last 1 hour, refresh at 50 min)
    if (this.jwtToken && this.tokenExpiry && Date.now() < this.tokenExpiry) {
      return this.jwtToken;
    }

    console.log('Fetching new JWT token...');
    const url = `${VERTESIA_CONFIG.VERTESIA_AUTH_BASE}/auth/token?token=${VERTESIA_CONFIG.VERTESIA_API_KEY}`;
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${VERTESIA_CONFIG.VERTESIA_API_KEY}`
      }
    });

    if (!response.ok) {
      const errorText = await response.text().catch(() => '');
      console.error('Auth token error:', response.status, errorText);
      throw new Error(`Auth failed: ${response.status}`);
    }

    const data = await response.json();
    this.jwtToken = data.token;
    // Set expiry to 50 minutes from now (tokens usually last 1 hour)
    this.tokenExpiry = Date.now() + (50 * 60 * 1000);
    
    console.log('JWT token obtained successfully');
    return this.jwtToken;
  }

  // Standard API call (uses API key)
  async call(endpoint, options = {}) {
    const url = `${VERTESIA_CONFIG.VERTESIA_API_BASE}${endpoint}`;
    console.log('API Call:', options.method || 'GET', endpoint);
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${VERTESIA_CONFIG.VERTESIA_API_KEY}`,
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    // Handle non-OK responses
    if (!response.ok) {
      const errorText = await response.text().catch(() => '');
      console.error('API Error:', response.status, errorText);
      throw new Error(`API ${response.status}: ${response.statusText}`);
    }
    
    // Handle 204 No Content and empty responses
    if (response.status === 204) {
      console.log('API: 204 No Content (success)');
      return null;
    }
    
    const text = await response.text();
    if (!text || text.trim() === '') {
      console.log('API: Empty response (success)');
      return null;
    }
    
    try {
      return JSON.parse(text);
    } catch (e) {
      console.log('API: Non-JSON response:', text.substring(0, 100));
      return null;
    }
  }

  // Authenticated API call for agent execution (uses JWT token)
  async callWithAuth(endpoint, options = {}) {
    const token = await this.getAuthToken();
    const url = `${VERTESIA_CONFIG.VERTESIA_API_BASE}${endpoint}`;
    console.log('API Call (JWT):', options.method || 'GET', endpoint);
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    if (!response.ok) {
      const errorText = await response.text().catch(() => '');
      console.error('API Error:', response.status, errorText);
      throw new Error(`API ${response.status}: ${response.statusText}`);
    }
    
    const text = await response.text();
    if (!text || text.trim() === '') return null;
    
    try {
      return JSON.parse(text);
    } catch (e) {
      return null;
    }
  }

  // Load all documents
  async loadAllObjects(limit = 1000) {
    const data = await this.call(`/objects?limit=${limit}&offset=0`);
    return Array.isArray(data) ? data : data.objects || [];
  }

  // Get single object
  async getObject(id) {
    return await this.call(`/objects/${id}`);
  }

  // Get download URL for file content
  async getDownloadUrl(fileSource) {
    return await this.call('/objects/download-url', {
      method: 'POST',
      body: JSON.stringify({ file: fileSource, format: 'original' })
    });
  }

  // Get file content as text
  async getFileContent(fileSource) {
    const { url } = await this.getDownloadUrl(fileSource);
    const response = await fetch(url);
    return await response.text();
  }

  // Load collections (workspaces)
  async loadCollections() {
    return await this.call('/collections/search', {
      method: 'POST',
      body: JSON.stringify({ dynamic: false, status: 'active', limit: 100 })
    });
  }

  // Get collection members (documents in workspace)
  async getCollectionMembers(collectionId) {
    return await this.call(`/collections/${collectionId}/members?limit=1000`);
  }

  // Create collection (workspace)
  async createCollection(name, description = '') {
    return await this.call('/collections', {
      method: 'POST',
      body: JSON.stringify({ name, description, dynamic: false })
    });
  }

  // Add documents to collection
  async addToCollection(collectionId, docIds) {
    return await this.call(`/collections/${collectionId}/members`, {
      method: 'POST',
      body: JSON.stringify({ action: 'add', members: docIds })
    });
  }

  // Remove from collection
  async removeFromCollection(collectionId, docIds) {
    return await this.call(`/collections/${collectionId}/members`, {
      method: 'POST',
      body: JSON.stringify({ action: 'delete', members: docIds })
    });
  }

  // Execute DocumentChat (requires JWT)
  async executeDocChat(task) {
    return await this.callWithAuth('/execute/async', {
      method: 'POST',
      body: JSON.stringify({
        type: 'conversation',
        interaction: VERTESIA_CONFIG.INTERACTION_CHAT,
        data: { task },
        config: { environment: VERTESIA_CONFIG.ENVIRONMENT_ID, model: VERTESIA_CONFIG.MODEL },
        interactive: true,
        max_iterations: 100
      })
    });
  }

  // Execute Research (requires JWT)
  async executeResearch(task) {
    return await this.callWithAuth('/execute/async', {
      method: 'POST',
      body: JSON.stringify({
        type: 'conversation',
        interaction: VERTESIA_CONFIG.INTERACTION_RESEARCH,
        data: { Task: task },
        config: { environment: VERTESIA_CONFIG.ENVIRONMENT_ID, model: VERTESIA_CONFIG.MODEL }
      })
    });
  }

  // Get run status
  async getRunStatus(workflowId, runId) {
    return await this.call(`/workflows/runs/${workflowId}/${runId}`);
  }

  // Stream response (requires JWT)
  async streamResponse(workflowId, runId, onMessage, onComplete, onError) {
    try {
      const token = await this.getAuthToken();
      const url = `${VERTESIA_CONFIG.VERTESIA_API_BASE}/workflows/runs/${workflowId}/${runId}/stream?since=${Date.now()}&access_token=${token}`;
      
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Stream error: ${response.status}`);
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (!line.startsWith('data:')) continue;
          try {
            const data = JSON.parse(line.slice(5).trim());
            if (onMessage) onMessage(data);
            if (data.type === 'finish' || data.finish_reason === 'stop') {
              if (onComplete) onComplete();
              return;
            }
          } catch (e) {}
        }
      }
      if (onComplete) onComplete();
    } catch (error) {
      if (onError) onError(error);
    }
  }

  // Extract clean answer from agent response
  extractAnswer(msg) {
    if (!msg) return '';
    const match = msg.match(/\*\*3\.\s*Agent Answer:\*\*\s*([\s\S]*?)(?=\*\*\d+\.|$)/i);
    return match ? match[1].trim() : msg;
  }
}

const api = new VertesiaAPI();

// ===== LIVE MODE STATE =====
let liveMode = false;
let allVertesiaDocs = [];      // All documents from API
let vertesiaCollections = [];  // Collections (workspaces) from API
let collectionMembers = {};    // collectionId -> [docIds]

// ===== DEMO DATA (FALLBACK) =====
// DATA
let workspaces = [
  { id: 1, name: 'Semiconductor Risk', pinned: true, status: 'active' },
  { id: 2, name: 'Energy M&A Analysis', pinned: false, status: 'active' },
  { id: 3, name: 'Q1 Portfolio Strategy', pinned: false, status: 'active' },
  { id: 4, name: 'Q3 Portfolio Review', pinned: false, status: 'completed' }
];

// Documents stored per workspace
let workspaceDocs = {
  1: [
    { id: 1, title: 'Semiconductor Ecosystem: TSMC Dependencies', type: 'Ecosystem Mapping', date: 'Dec 28 · 2:34 PM', parentId: null },
    { id: 2, title: 'ASML Equipment Dependency Analysis', type: 'Deep Dive', date: 'Dec 28 · 4:15 PM', parentId: 1 },
    { id: 3, title: 'Competitive Dynamics: Foundry Market', type: "Porter's Five Forces", date: 'Dec 27 · 10:15 AM', parentId: null },
    { id: 4, title: 'NVDA vs AMD Valuation Comparison', type: 'DCF Valuation', date: 'Dec 26 · 3:45 PM', parentId: null }
  ],
  2: [
    { id: 10, title: 'Chevron Acquisition Analysis', type: 'M&A Analysis', date: 'Dec 27', parentId: null },
    { id: 11, title: 'Exxon Portfolio Synergies', type: 'Research', date: 'Dec 26', parentId: null },
    { id: 12, title: 'Energy Sector Consolidation Trends', type: 'Industry Analysis', date: 'Dec 25', parentId: null }
  ],
  3: [
    { id: 20, title: 'Q1 Macro Outlook', type: 'Research', date: 'Dec 28', parentId: null },
    { id: 21, title: 'Sector Rotation Analysis', type: 'Research', date: 'Dec 27', parentId: null },
    { id: 22, title: 'Fixed Income Strategy', type: 'Research', date: 'Dec 26', parentId: null },
    { id: 23, title: 'Equity Allocation Model', type: 'DCF Valuation', date: 'Dec 25', parentId: null },
    { id: 24, title: 'Risk Parity Assessment', type: 'Risk Modeling', date: 'Dec 24', parentId: null }
  ],
  4: [
    { id: 30, title: 'Q3 Performance Summary', type: 'Report', date: 'Dec 15', parentId: null },
    { id: 31, title: 'Attribution Analysis', type: 'Research', date: 'Dec 14', parentId: null }
  ]
};

let currentWs = workspaces[0];
let documents = workspaceDocs[1]; // Current workspace's docs

let libraryDocs = [
  { id: 101, title: "Sub Zero's AI Adoption Positioning", type: 'Research', date: 'Dec 29' },
  { id: 102, title: 'Integrated Investment Strategy Report', type: 'Report', date: 'Dec 29' },
  { id: 103, title: 'Intel Foundry Services Analysis', type: 'Research', date: 'Dec 27' },
  { id: 104, title: 'GlobalFoundries Capacity Report', type: 'Research', date: 'Dec 26' },
  { id: 105, title: 'Taiwan Geopolitical Risk Assessment', type: 'Research', date: 'Dec 20' }
];
let relatedDocs = [
  { id: 201, title: 'Intel Foundry Services Analysis', match: 'semiconductor manufacturing' },
  { id: 202, title: 'Taiwan Geopolitical Risk Assessment', match: 'supply chain risk' },
  { id: 203, title: 'NVIDIA Q3 Earnings Analysis', match: 'NVDA, technology' },
  { id: 204, title: 'Advanced Packaging Technology Trends', match: 'semiconductor, TSMC' }
];
let pulseArticles = ['Federal Reserve Cuts Rates Amid Division', 'Tech Sector AI-Driven Bifurcation', 'Healthcare Shows Resilience', 'Manufacturing Faces Headwinds', 'Energy Sector Operational Excellence'];
let researchTypes = [
  { id: 'supply', name: 'Supply Chain Contagion', desc: 'Disruption effects' },
  { id: 'risk', name: 'Risk Modeling', desc: 'Portfolio impact' },
  { id: 'ecosystem', name: 'Ecosystem Mapping', desc: 'Dependencies' },
  { id: 'dcf', name: 'DCF Valuation', desc: 'Intrinsic value' },
  { id: 'porter', name: "Porter's Five Forces", desc: 'Competitive dynamics' }
];
let activeJobs = [
  { id: 1, name: 'Supply Chain Contagion', time: 2, wsId: 1 },
  { id: 2, name: 'Risk Modeling', time: 4, wsId: 1 }
];
let jobId = 2;
const focusOpts = {
  traditional: ['General Analysis', 'DCF Valuation', "Porter's Five Forces"],
  ecosystem: ['Ecosystem Mapping', 'Supply Chain Contagion'],
  scenario: ['Risk Modeling', 'M&A Analysis']
};

// CHAT STATE
let chatMessages = [];
let chatMessageCount = 0; // Start fresh
let currentChatId = null;
let chatIsSaved = true; // Track if current chat is saved

// FOLLOW-UP RESEARCH STATE
let followUpParentDoc = null; // { id, title } when in follow-up mode

// Chat persistence
const WORKSPACE_CHATS_STORAGE_KEY = 'marketlens_workspace_chats';
const CHAT_LIMIT = 10; // Max messages per chat

// Load saved chats from localStorage
function loadWorkspaceChats() {
  try {
    const saved = localStorage.getItem(WORKSPACE_CHATS_STORAGE_KEY);
    return saved ? JSON.parse(saved) : {};
  } catch (e) {
    console.error('Failed to load workspace chats:', e);
    return {};
  }
}

// Save chats to localStorage
function saveWorkspaceChats() {
  try {
    localStorage.setItem(WORKSPACE_CHATS_STORAGE_KEY, JSON.stringify(workspaceChats));
  } catch (e) {
    console.error('Failed to save workspace chats:', e);
  }
}

// Saved chats per workspace - loaded from localStorage
let workspaceChats = loadWorkspaceChats();

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
  // Fallback: hide loading after 10 seconds no matter what
  setTimeout(() => hideLoading(), 10000);
  
  try {
    setLoadingText('Loading documents...');
    await loadFromAPI();
    setApiStatus('connected');
    liveMode = true;
    console.log('Live mode enabled');
  } catch (error) {
    console.error('API connection failed, using demo mode:', error);
    setApiStatus('error');
    liveMode = false;
  }
  
  hideLoading();
  renderSidebar();
  renderDocuments();
  renderLibrary();
  renderPulse();
  renderBatchTypes();
  updateJobs();
  updateChatUsage();
  renderChatHistory();
});

async function loadFromAPI() {
  // 1. Load all documents
  setLoadingText('Loading documents...');
  const objects = await api.loadAllObjects();
  allVertesiaDocs = objects.filter(o => o.content?.source).map(o => ({
    id: o.id,
    title: o.name || 'Untitled',
    type: o.properties?.framework || o.properties?.document_type || 'Research',
    date: formatApiDate(o.created_at),
    source: o.content?.source,
    parentId: o.parent || null
  }));
  console.log(`Loaded ${allVertesiaDocs.length} documents from API`);

  // Update library with all docs
  libraryDocs = allVertesiaDocs;

  // 2. Load collections as workspaces
  setLoadingText('Loading workspaces...');
  let collections = [];
  try {
    collections = await api.loadCollections() || [];
    console.log(`Loaded ${collections.length} collections from API`);
  } catch (e) {
    console.warn('Failed to load collections:', e);
  }
  
  vertesiaCollections = collections;
  
  if (collections.length > 0) {
    // Map collections to workspaces format
    workspaces = collections.map((c, i) => ({
      id: c.id,
      name: c.name,
      pinned: i === 0,
      status: 'active'
    }));

    // 3. Load members for each collection
    setLoadingText('Loading workspace contents...');
    workspaceDocs = {};
    for (const c of collections) {
      try {
        const members = await api.getCollectionMembers(c.id) || [];
        const memberIds = members.map(m => m.id);
        collectionMembers[c.id] = memberIds;
        
        // Map to workspace docs format
        workspaceDocs[c.id] = memberIds.map(docId => {
          return allVertesiaDocs.find(d => d.id === docId);
        }).filter(Boolean);
        
        console.log(`Collection ${c.name}: ${workspaceDocs[c.id].length} docs`);
      } catch (e) {
        console.warn(`Failed to load members for ${c.name}:`, e);
        workspaceDocs[c.id] = [];
        collectionMembers[c.id] = [];
      }
    }

    currentWs = workspaces[0];
    documents = workspaceDocs[currentWs.id] || [];
    console.log(`Active workspace: ${currentWs.name} with ${documents.length} docs`);
  } else {
    console.log('No collections found, using demo workspaces');
  }
}

function formatApiDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function setLoadingText(text) {
  const el = document.getElementById('loadingText');
  if (el) el.textContent = text;
}

function hideLoading() {
  document.getElementById('loadingOverlay')?.classList.add('hidden');
}

function setApiStatus(status) {
  const dot = document.getElementById('apiDot');
  const text = document.getElementById('apiStatusText');
  if (!dot) return;
  dot.className = 'api-dot ' + status;
  if (text) text.textContent = status === 'connected' ? 'Live' : status === 'error' ? 'Demo' : 'Connecting...';
}

// MODALS
function openModal(id) {
  document.getElementById(id).classList.add('open');
  if (id === 'newWorkspace') renderDocPicker('newWsPicker', libraryDocs);
  if (id === 'addDocuments') renderDocPicker('addDocsPicker', libraryDocs);
  if (id === 'findRelated') renderDocPicker('findRelatedPicker', relatedDocs, true);
  if (id === 'generateReport') renderReportPicker();
  if (id === 'batchResearch') { document.getElementById('batchStep1').classList.add('active'); document.getElementById('batchStep2').classList.remove('active'); }
}
function closeModal(id) { 
  document.getElementById(id).classList.remove('open'); 
  if (id === 'research') resetResearchModal();
}

// SIDEBAR
function renderSidebar() {
  let html = '<div class="section-label">Pinned</div><div class="workspace-list">';
  workspaces.filter(w => w.pinned).forEach(w => html += wsItem(w));
  html += '</div><div class="section-label">Active</div><div class="workspace-list">';
  workspaces.filter(w => !w.pinned && w.status === 'active').forEach(w => html += wsItem(w));
  html += '</div><div class="section-label">Completed</div><div class="workspace-list">';
  workspaces.filter(w => w.status === 'completed').forEach(w => html += wsItem(w));
  html += '</div>';
  document.getElementById('sidebarContent').innerHTML = html;
}

function wsItem(w) {
  const active = currentWs?.id === w.id ? 'active' : '';
  const pin = w.pinned ? '<svg class="pin-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>' : '';
  const wsJobs = activeJobs.filter(j => j.wsId === w.id);
  const docCount = (workspaceDocs[w.id] || []).length;
  const meta = wsJobs.length > 0 ? `<span class="activity-dot"></span> ${wsJobs.length} generating` : `${docCount} doc${docCount !== 1 ? 's' : ''}`;
  // Fix: Use escaped single quotes for string IDs
  const idAttr = typeof w.id === 'string' ? `'${w.id}'` : w.id;
  return `<div class="workspace-item ${active}" onclick="selectWs(${idAttr})">
    <div class="workspace-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
    <div class="workspace-info">
      <div class="workspace-name">${w.name} ${pin}</div>
      <div class="workspace-meta">${meta}</div>
    </div>
    <button class="workspace-menu-btn" onclick="event.stopPropagation();toggleWsMenu(${idAttr})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></button>
    <div class="workspace-menu" id="wsMenu${w.id}">
      <div class="workspace-menu-item" onclick="event.stopPropagation();renameWs(${idAttr})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Rename</div>
      <div class="workspace-menu-item" onclick="event.stopPropagation();togglePin(${idAttr})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg> ${w.pinned ? 'Unpin' : 'Pin'}</div>
      <div class="workspace-menu-item" onclick="event.stopPropagation();toggleComplete(${idAttr})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${w.status === 'completed' ? 'Reopen' : 'Mark Complete'}</div>
      <div class="menu-divider"></div>
      <div class="workspace-menu-item danger" onclick="event.stopPropagation();deleteWs(${idAttr})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Delete</div>
    </div>
  </div>`;
}

function selectWs(id) {
  // Check for unsaved chat before switching
  if (chatMessages.length > 0 && !chatIsSaved) {
    if (!confirm('Switch workspace?\n\nYour current chat is not saved and will be lost.')) {
      return;
    }
  }
  
  console.log('Selecting workspace:', id, typeof id);
  currentWs = workspaces.find(w => w.id === id);
  
  if (!currentWs) {
    console.error('Workspace not found:', id);
    return;
  }
  
  // Get documents for this workspace
  documents = workspaceDocs[id] || [];
  console.log('Loaded', documents.length, 'documents for workspace');
  
  renderSidebar();
  renderDocuments();
  updateHeader();
  resetChat();
  renderChatHistory();
  closeChatHistory();
}

function resetChat() {
  chatMessages = [];
  chatMessageCount = 0;
  currentChatId = null;
  chatIsSaved = true;
  
  // Reset streaming state
  isChatStreaming = false;
  const sendBtn = document.getElementById('chatSend');
  if (sendBtn) sendBtn.disabled = false;
  
  updateChatUsage();
  
  if (documents.length > 0) {
    document.getElementById('chatMessages').innerHTML = `
      <div class="chat-message ai">
        <div class="message-bubble">I've loaded the contents of this workspace. What would you like to explore?</div>
        <div class="message-footer">
          <span class="message-time">Scout · Just now</span>
          <div class="message-actions">
            <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
          </div>
        </div>
      </div>
    `;
  } else {
    // Empty workspace - show welcome with suggestions
    document.getElementById('chatMessages').innerHTML = `
      <div class="chat-welcome">
        <div class="chat-welcome-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </div>
        <h3>Start a Conversation</h3>
        <p>Add documents to this workspace, then ask questions about them.</p>
      </div>
    `;
  }
}

function updateHeader() {
  document.getElementById('workspaceTitle').innerHTML = currentWs.name + (currentWs.pinned ? ' <svg class="pin-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>' : '');
}
function toggleWsMenu(id) {
  document.querySelectorAll('.workspace-menu').forEach(m => m.classList.remove('open'));
  document.getElementById('wsMenu' + id).classList.toggle('open');
}
document.addEventListener('click', () => document.querySelectorAll('.workspace-menu').forEach(m => m.classList.remove('open')));

async function renameWs(id) {
  const w = workspaces.find(x => x.id === id);
  const n = prompt('Rename:', w.name);
  if (!n || !n.trim()) return;
  
  const newName = n.trim();
  
  // Call API if live mode with string ID
  if (liveMode && typeof id === 'string') {
    try {
      await api.call(`/collections/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ name: newName })
      });
      console.log('Collection renamed via API:', id, newName);
    } catch (error) {
      console.error('Failed to rename collection:', error);
      alert('Failed to rename workspace. Please try again.');
      return;
    }
  }
  
  w.name = newName;
  renderSidebar();
  if (currentWs.id === id) updateHeader();
}

function togglePin(id) {
  const w = workspaces.find(x => x.id === id);
  w.pinned = !w.pinned;
  renderSidebar();
  if (currentWs.id === id) updateHeader();
}
function toggleComplete(id) {
  const w = workspaces.find(x => x.id === id);
  w.status = w.status === 'completed' ? 'active' : 'completed';
  if (w.status === 'completed') w.pinned = false;
  renderSidebar();
}

async function deleteWs(id) {
  const w = workspaces.find(x => x.id === id);
  if (!confirm(`Delete "${w.name}"?`)) return;
  
  // Call API if live mode with string ID
  if (liveMode && typeof id === 'string') {
    try {
      await api.call(`/collections/${id}`, {
        method: 'DELETE'
      });
      console.log('Collection deleted via API:', id);
    } catch (error) {
      console.error('Failed to delete collection:', error);
      alert('Failed to delete workspace. Please try again.');
      return;
    }
  }
  
  workspaces = workspaces.filter(x => x.id !== id);
  delete workspaceDocs[id];
  delete collectionMembers[id];
  
  if (currentWs.id === id && workspaces.length) {
    currentWs = workspaces[0];
    documents = workspaceDocs[currentWs.id] || [];
  }
  renderSidebar();
  renderDocuments();
  updateHeader();
}
function filterWorkspaces(q) {
  document.querySelectorAll('.workspace-item').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q.toLowerCase()) ? 'flex' : 'none';
  });
}

async function createWorkspace() {
  const name = document.getElementById('newWsName').value.trim();
  if (!name) { alert('Enter a name'); return; }
  
  let wsId;
  let ws;
  
  // If live mode, create via API
  if (liveMode) {
    try {
      const btn = document.querySelector('#newWorkspace .action-btn.primary');
      if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
      
      const collection = await api.createCollection(name, `Created from MarketLens on ${new Date().toLocaleDateString()}`);
      console.log('createCollection response:', collection);
      
      // Handle case where API returns empty/null - we need to reload collections
      if (!collection || !collection.id) {
        console.log('Collection created but no ID returned, reloading collections...');
        // Reload collections to get the new one
        const collections = await api.loadCollections() || [];
        const newCollection = collections.find(c => c.name === name);
        if (newCollection) {
          wsId = newCollection.id;
        } else {
          throw new Error('Could not find newly created collection');
        }
      } else {
        wsId = collection.id;
      }
      
      ws = { id: wsId, name, pinned: false, status: 'active' };
      
      // Add selected docs to collection
      const picker = document.getElementById('newWsPicker');
      const selected = picker.querySelectorAll('.doc-picker-item.selected');
      const docIds = Array.from(selected).map(el => el.dataset.docId).filter(id => id);
      
      if (docIds.length > 0) {
        await api.addToCollection(wsId, docIds);
        console.log('Documents added to collection');
        collectionMembers[wsId] = docIds;
        workspaceDocs[wsId] = docIds.map(id => allVertesiaDocs.find(d => d.id === id)).filter(Boolean);
      } else {
        workspaceDocs[wsId] = [];
        collectionMembers[wsId] = [];
      }
      
      if (btn) { btn.disabled = false; btn.textContent = 'Create Workspace'; }
      console.log('Created workspace via API:', wsId);
      
    } catch (error) {
      console.error('Failed to create workspace via API:', error);
      alert('Failed to create workspace. Please try again.');
      const btn = document.querySelector('#newWorkspace .action-btn.primary');
      if (btn) { btn.disabled = false; btn.textContent = 'Create Workspace'; }
      return;
    }
  } else {
    // Demo mode
    wsId = Date.now();
    ws = { id: wsId, name, pinned: false, status: 'active' };
    workspaceDocs[wsId] = [];
    
    const picker = document.getElementById('newWsPicker');
    const selected = picker.querySelectorAll('.doc-picker-item.selected');
    selected.forEach(el => {
      const title = el.querySelector('.doc-picker-title').textContent;
      const meta = el.querySelector('.doc-picker-meta').textContent;
      const type = meta.split(' · ')[1] || 'Research';
      workspaceDocs[wsId].push({
        id: Date.now() + Math.random(),
        title,
        type,
        date: 'Just now',
        parentId: null
      });
    });
  }
  
  workspaces.unshift(ws);
  currentWs = ws;
  documents = workspaceDocs[wsId] || [];
  
  renderSidebar();
  renderDocuments();
  updateHeader();
  resetChat();
  
  document.getElementById('newWsName').value = '';
  closeModal('newWorkspace');
}

// DOCUMENTS
function renderDocuments() {
  const listEl = document.getElementById('documentList');
  
  if (documents.length === 0) {
    listEl.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.4;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        <div style="font-size: 15px; font-weight: 600; color: var(--ink); margin-bottom: 8px;">No documents yet</div>
        <div style="font-size: 13px; margin-bottom: 20px;">Add documents from your library or run research to get started.</div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button class="action-btn" onclick="openModal('addDocuments')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Documents
          </button>
          <button class="action-btn primary" onclick="openModal('research')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Start Research
          </button>
        </div>
      </div>
    `;
    document.getElementById('docCount').textContent = '';
    return;
  }
  
  listEl.innerHTML = documents.map(d => {
    const isChild = d.parentId !== null;
    const safeTitle = d.title.replace(/'/g, "\\'");
    // Handle string IDs (from API) vs numeric IDs (demo)
    const idAttr = typeof d.id === 'string' ? `'${d.id}'` : d.id;
    return `<div class="document-card ${isChild ? 'is-child' : ''}">
      ${isChild ? '<div class="child-indicator">↳ Follow-up</div>' : ''}
      <div class="document-card-header">
        <span class="document-type">${d.type}</span>
        <div class="document-actions">
          <button class="doc-action-btn" onclick="viewDoc('${safeTitle}')" title="View"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          ${!isChild ? `<button class="doc-action-btn" onclick="openFollowUpResearch('${safeTitle}', ${idAttr})" title="Follow-up Research"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>` : ''}
          <button class="doc-action-btn danger" onclick="removeDoc(${idAttr})" title="Remove from Workspace"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
      </div>
      <div class="document-title">${d.title}</div>
      <div class="document-meta">${d.date}</div>
    </div>`;
  }).join('');
  document.getElementById('docCount').textContent = ` · ${documents.length} total`;
}

async function removeDoc(id) {
  if (!confirm('Remove this document from the workspace?\n\nThis only removes it from this workspace—the document will still be available in your Library.')) {
    return;
  }
  
  // Call API if live mode with string IDs
  if (liveMode && typeof currentWs.id === 'string' && typeof id === 'string') {
    try {
      await api.removeFromCollection(currentWs.id, [id]);
      console.log('Document removed from collection via API:', id);
    } catch (error) {
      console.error('Failed to remove document from collection:', error);
      // Continue with local update even if API fails
    }
  }
  
  documents = documents.filter(d => d.id !== id);
  workspaceDocs[currentWs.id] = documents;
  if (collectionMembers[currentWs.id]) {
    collectionMembers[currentWs.id] = collectionMembers[currentWs.id].filter(docId => docId !== id);
  }
  renderDocuments();
  renderSidebar();
}

// JOBS
function toggleJobs() {
  document.getElementById('jobsToast').classList.toggle('collapsed');
}
function updateJobs() {
  document.getElementById('jobsBadge').textContent = activeJobs.length;
  document.getElementById('jobsBody').innerHTML = activeJobs.length === 0
    ? '<div class="jobs-empty">No research running</div>'
    : activeJobs.map(j => `<div class="job-item"><div class="job-spinner"></div><div class="job-info"><div class="job-name">${j.name}</div><div class="job-progress">~${j.time} min</div></div></div>`).join('');
  renderSidebar();
}

function addJob(name, skipFakeTimer = false) {
  const job = { id: ++jobId, name, time: Math.floor(Math.random() * 3) + 2, wsId: currentWs.id };
  activeJobs.push(job);
  updateJobs();
  renderSidebar();
  document.getElementById('jobsToast').classList.remove('collapsed');
  
  // Only use fake timer if not in live mode or if not skipFakeTimer
  if (!liveMode && !skipFakeTimer) {
    setTimeout(() => {
      removeJob(name);
      
      // Add demo document to workspace
      const newDoc = { id: Date.now(), title: name, type: 'Research', date: 'Just now', parentId: null };
      if (!workspaceDocs[job.wsId]) workspaceDocs[job.wsId] = [];
      workspaceDocs[job.wsId].unshift(newDoc);
      
      if (currentWs.id === job.wsId) {
        documents = workspaceDocs[job.wsId];
        renderDocuments();
      }
      renderSidebar();
    }, 5000 + Math.random() * 5000);
  }
}

function removeJob(name) {
  activeJobs = activeJobs.filter(j => j.name !== name);
  updateJobs();
  renderSidebar();
}

// DOC PICKERS
function renderDocPicker(containerId, docs, isRelated = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = `
    ${!isRelated ? '<div class="doc-picker-search"><input type="text" placeholder="Search..." oninput="filterPicker(this)"></div>' : ''}
    <div class="doc-picker-list">${docs.map(d => `
      <div class="doc-picker-item" data-doc-id="${d.id}" onclick="togglePickerItem(this)">
        <div class="doc-picker-checkbox"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        <div class="doc-picker-info">
          <div class="doc-picker-title">${d.title}</div>
          <div class="doc-picker-meta">${isRelated ? 'Matched: ' + d.match : d.date + ' · ' + d.type}</div>
        </div>
      </div>
    `).join('')}</div>
    <div class="doc-picker-footer">${docs.length} documents available · 0 selected</div>
  `;
}
function togglePickerItem(el) {
  el.classList.toggle('selected');
  const picker = el.closest('.doc-picker');
  const count = picker.querySelectorAll('.doc-picker-item.selected').length;
  const total = picker.querySelectorAll('.doc-picker-item').length;
  picker.querySelector('.doc-picker-footer').textContent = `${total} documents available · ${count} selected`;
}
function filterPicker(input) {
  const q = input.value.toLowerCase();
  input.closest('.doc-picker').querySelectorAll('.doc-picker-item').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  });
}

async function addDocsToWorkspace(pickerId) {
  const picker = document.getElementById(pickerId);
  const selected = picker.querySelectorAll('.doc-picker-item.selected');
  if (!selected.length) { alert('Select at least one document'); return; }
  
  const docIds = Array.from(selected).map(el => el.dataset.docId).filter(id => id);
  
  if (liveMode && typeof currentWs.id === 'string') {
    // API mode - add to collection
    if (docIds.length > 0) {
      try {
        console.log('Adding docs to workspace:', currentWs.id, docIds);
        await api.addToCollection(currentWs.id, docIds);
        // API call succeeded (even if returned null/204)
        console.log('API call successful - documents added');
      } catch (error) {
        console.error('Failed to add docs to collection:', error);
        alert('Failed to add documents. Please try again.');
        return;
      }
      
      // Update local state after successful API call
      docIds.forEach(docId => {
        const doc = allVertesiaDocs.find(d => d.id === docId);
        if (doc && !documents.find(d => d.id === docId)) {
          documents.push(doc);
          if (!collectionMembers[currentWs.id]) collectionMembers[currentWs.id] = [];
          collectionMembers[currentWs.id].push(docId);
        }
      });
      console.log('Local state updated, documents:', documents.length);
    }
  } else {
    // Demo mode
    selected.forEach(el => {
      const title = el.querySelector('.doc-picker-title').textContent;
      documents.push({ id: Date.now() + Math.random(), title, type: 'Added', date: 'Just now', parentId: null });
    });
  }
  
  workspaceDocs[currentWs.id] = documents;
  renderDocuments();
  renderSidebar();
  closeModal(pickerId === 'addDocsPicker' ? 'addDocuments' : 'findRelated');
}

// RESEARCH
function updateFocus() {
  const t = document.getElementById('researchType').value;
  const opts = focusOpts[t] || [];
  document.getElementById('researchFocus').innerHTML = opts.length
    ? '<option value="">Select focus...</option>' + opts.map(o => `<option value="${o}">${o}</option>`).join('')
    : '<option value="">Choose type first...</option>';
}

async function startResearch() {
  const type = document.getElementById('researchType').value;
  const focus = document.getElementById('researchFocus').value;
  const context = document.getElementById('researchContext')?.value?.trim() || '';
  const scope = document.getElementById('researchScope')?.value || 'Asset';
  const rigor = document.getElementById('researchRigor')?.value || 'In Depth';
  
  if (!focus) { alert('Select type and focus'); return; }
  
  // Create job with parent info if follow-up
  const jobName = followUpParentDoc ? `Follow-up: ${focus}` : focus;
  
  // Build prompt
  let prompt = '';
  
  if (followUpParentDoc) {
    prompt = `FOLLOW-UP RESEARCH REQUEST

First, access and analyze Document ID: ${followUpParentDoc.id} from the content object library.
Parent document: ${followUpParentDoc.title}
IMPORTANT: When creating the output document, set the parent metadata to reference document ID: ${followUpParentDoc.id}

The user wants to explore: ${context || 'Further analysis based on the parent document'}

Use insights from the parent document to enhance this research.

`;
  }
  
  prompt += `Analysis Type: ${type || 'General'}
Framework: ${focus}
Scope: ${scope}
Analytical Rigor: ${rigor}
Context: ${context || 'General analysis'}

Generate a comprehensive research document with hyperlinked sources.
The final output must be a document uploaded to the content object library.
`;

  console.log('Starting research:', { focus, scope, rigor, context, hasParent: !!followUpParentDoc });
  
  // Call API if in live mode
  if (liveMode) {
    try {
      const response = await api.executeResearch(prompt);
      console.log('Research started:', response);
      
      // Add to active jobs (skip fake timer since we're polling)
      addJob(jobName, true);
      
      // Poll for completion
      if (response.runId && response.workflowId) {
        pollResearchCompletion(response.workflowId, response.runId, jobName);
      }
    } catch (error) {
      console.error('Failed to start research:', error);
      alert('Failed to start research. Please try again.');
      return;
    }
  } else {
    // Demo mode
    addJob(jobName, false);
  }
  
  closeModal('research');
  resetResearchModal();
}

async function pollResearchCompletion(workflowId, runId, jobName) {
  let attempts = 0;
  const maxAttempts = 60;
  
  const poll = setInterval(async () => {
    attempts++;
    if (attempts > maxAttempts) {
      clearInterval(poll);
      removeJob(jobName);
      console.log('Research timed out');
      return;
    }
    
    try {
      const status = await api.getRunStatus(workflowId, runId);
      const runStatus = (status?.status || '').toLowerCase();
      
      if (['completed', 'finished', 'done'].includes(runStatus)) {
        clearInterval(poll);
        removeJob(jobName);
        
        // Reload documents
        const objects = await api.loadAllObjects();
        allVertesiaDocs = objects.filter(o => o.content?.source).map(o => ({
          id: o.id,
          title: o.name || 'Untitled',
          type: o.properties?.framework || o.properties?.document_type || 'Research',
          date: formatApiDate(o.created_at),
          source: o.content?.source,
          parentId: o.parent || null
        }));
        libraryDocs = allVertesiaDocs;
        
        console.log('Research completed, docs reloaded');
        renderSidebar();
        
      } else if (['failed', 'error'].includes(runStatus)) {
        clearInterval(poll);
        removeJob(jobName);
        console.error('Research failed');
      }
    } catch (e) {
      console.error('Poll error:', e);
    }
  }, 15000);
}

function resetResearchModal() {
  followUpParentDoc = null;
  document.getElementById('researchModalTitle').textContent = 'Research';
  document.getElementById('researchModalDesc').textContent = 'Generate a single research document. Output will be added to this workspace.';
  document.getElementById('researchSubmitBtn').textContent = 'Generate Research';
  document.getElementById('researchType').value = '';
  document.getElementById('researchFocus').innerHTML = '<option value="">Choose type first...</option>';
  document.getElementById('researchContext').value = '';
  document.getElementById('parentDocGroup').style.display = 'none';
  document.getElementById('parentDocDisplay').innerHTML = '';
}

function openFollowUpResearch(docTitle, docId) {
  if (!docTitle) {
    console.error('No parent document specified');
    openModal('research');
    return;
  }
  
  followUpParentDoc = { id: docId, title: docTitle };
  
  // Update modal for follow-up mode
  document.getElementById('researchModalTitle').textContent = 'Follow Up Research';
  document.getElementById('researchModalDesc').textContent = 'Generate follow-up research based on an existing document. Output will be added to this workspace.';
  document.getElementById('researchSubmitBtn').textContent = 'Generate Follow-up';
  
  // Show parent document
  document.getElementById('parentDocGroup').style.display = 'block';
  document.getElementById('parentDocDisplay').innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    <span class="parent-doc-name">${docTitle}</span>
  `;
  
  openModal('research');
}

// BATCH RESEARCH
function renderBatchTypes() {
  document.getElementById('batchTypes').innerHTML = researchTypes.map(rt => `
    <div class="research-type" onclick="toggleBatchType(this)">
      <div class="research-type-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="research-type-info">
        <div class="research-type-name">${rt.name}</div>
        <div class="research-type-desc">${rt.desc}</div>
      </div>
      <div class="quantity-stepper">
        <button class="stepper-btn" onclick="event.stopPropagation();adjustQty(this,-1)">−</button>
        <span class="stepper-value">×1</span>
        <button class="stepper-btn" onclick="event.stopPropagation();adjustQty(this,1)">+</button>
      </div>
    </div>
  `).join('');
}
function toggleBatchType(el) {
  el.classList.toggle('selected');
  updateBatchTotal();
}
function adjustQty(btn, d) {
  const v = btn.parentElement.querySelector('.stepper-value');
  let n = parseInt(v.textContent.replace('×', ''));
  n = Math.max(1, Math.min(3, n + d));
  v.textContent = '×' + n;
  updateBatchTotal();
}
function updateBatchTotal() {
  let t = 0;
  document.querySelectorAll('#batchTypes .research-type.selected').forEach(el => {
    t += parseInt(el.querySelector('.stepper-value').textContent.replace('×', ''));
  });
  document.getElementById('batchTotal').textContent = t;
}
function showBatchConfirm() {
  const sel = document.querySelectorAll('#batchTypes .research-type.selected');
  if (!sel.length) { alert('Select at least one type'); return; }
  document.getElementById('confirmList').innerHTML = Array.from(sel).map(el => `
    <div class="confirm-item">
      <span class="confirm-item-name">${el.querySelector('.research-type-name').textContent}</span>
      <span class="confirm-item-qty">${el.querySelector('.stepper-value').textContent}</span>
    </div>
  `).join('');
  document.getElementById('batchStep1').classList.remove('active');
  document.getElementById('batchStep2').classList.add('active');
}
function showBatchConfig() {
  document.getElementById('batchStep2').classList.remove('active');
  document.getElementById('batchStep1').classList.add('active');
}
function startBatchResearch() {
  const topic = document.getElementById('batchTopic')?.value?.trim() || '';
  const scope = document.getElementById('researchScope')?.value || 'Asset';
  const rigor = document.getElementById('researchRigor')?.value || 'In Depth';
  const selected = document.querySelectorAll('#batchTypes .research-type.selected');
  
  selected.forEach(async (el) => {
    const name = el.querySelector('.research-type-name').textContent;
    const qty = parseInt(el.querySelector('.stepper-value').textContent.replace('×', ''));
    
    for (let i = 0; i < qty; i++) {
      const jobName = qty > 1 ? `${name} (${i + 1})` : name;
      
      // Call API if in live mode
      if (liveMode) {
        addJob(jobName, true); // Skip fake timer
        try {
          const prompt = `Research Type: ${name}
Topic: ${topic || 'General analysis'}
Scope: ${scope}
Analytical Rigor: ${rigor}

Generate comprehensive research with hyperlinked sources.
The final output must be a document uploaded to the content object library.`;
          const response = await api.executeResearch(prompt);
          if (response.runId && response.workflowId) {
            pollResearchCompletion(response.workflowId, response.runId, jobName);
          }
        } catch (error) {
          console.error('Batch research failed:', error);
          removeJob(jobName);
        }
      } else {
        addJob(jobName, false); // Use fake timer in demo mode
      }
    }
    
    el.classList.remove('selected');
    el.querySelector('.stepper-value').textContent = '×1';
  });
  
  updateBatchTotal();
  closeModal('batchResearch');
}

// REPORT
function renderReportPicker() {
  const picker = document.getElementById('reportPicker');
  picker.innerHTML = `
    <div class="doc-picker-list" style="max-height:180px">${documents.map(d => `
      <div class="doc-picker-item selected" onclick="togglePickerItem(this);updateReportBtn()">
        <div class="doc-picker-checkbox"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
        <div class="doc-picker-info">
          <div class="doc-picker-title">${d.title}</div>
          <div class="doc-picker-meta">${d.type}</div>
        </div>
      </div>
    `).join('')}</div>
    <div class="doc-picker-footer">${documents.length} documents selected</div>
  `;
}
function toggleAllReportDocs() {
  const picker = document.getElementById('reportPicker');
  const items = picker.querySelectorAll('.doc-picker-item');
  const allSel = Array.from(items).every(i => i.classList.contains('selected'));
  items.forEach(i => allSel ? i.classList.remove('selected') : i.classList.add('selected'));
  const count = picker.querySelectorAll('.doc-picker-item.selected').length;
  picker.querySelector('.doc-picker-footer').textContent = count + ' documents selected';
  document.querySelector('#generateReport .select-all-btn').textContent = allSel ? 'Select All' : 'Deselect All';
}
function updateReportBtn() {
  const picker = document.getElementById('reportPicker');
  const items = picker.querySelectorAll('.doc-picker-item');
  const count = picker.querySelectorAll('.doc-picker-item.selected').length;
  picker.querySelector('.doc-picker-footer').textContent = count + ' documents selected';
  const allSel = Array.from(items).every(i => i.classList.contains('selected'));
  document.querySelector('#generateReport .select-all-btn').textContent = allSel ? 'Deselect All' : 'Select All';
}
async function generateReport() {
  const t = document.getElementById('reportTitle').value.trim();
  if (!t) { alert('Enter a title'); return; }
  const sel = document.querySelectorAll('#reportPicker .doc-picker-item.selected');
  if (!sel.length) { alert('Select documents'); return; }
  
  // Use defaults for reports - could add selectors to modal later
  const scope = 'Asset';
  const rigor = 'Comprehensive';
  
  const jobName = 'Report: ' + t;
  
  // Call API if in live mode
  if (liveMode) {
    addJob(jobName, true); // Skip fake timer
    try {
      // Get selected document IDs
      const docIds = documents.filter(d => typeof d.id === 'string').map(d => d.id);
      const docNames = documents.map(d => d.title).join(', ');
      
      const prompt = `REPORT GENERATION REQUEST

Title: ${t}
Workspace: ${currentWs?.name || 'Current Workspace'}
Scope: ${scope}
Analytical Rigor: ${rigor}

Analyze and synthesize the following documents:
${docNames}

Document IDs: ${docIds.join(', ')}

Generate a comprehensive report that synthesizes insights from all documents with proper citations.
The final output must be a document uploaded to the content object library.`;

      console.log('Generating report:', { title: t, scope, rigor, docCount: docIds.length });
      const response = await api.executeResearch(prompt);
      
      if (response.runId && response.workflowId) {
        pollResearchCompletion(response.workflowId, response.runId, jobName);
      }
    } catch (error) {
      console.error('Report generation failed:', error);
      removeJob(jobName);
      alert('Failed to start report generation. Please try again.');
    }
  } else {
    // Demo mode
    addJob(jobName, false);
  }
  
  closeModal('generateReport');
}

// LIBRARY & PULSE
function renderLibrary() {
  document.getElementById('libraryList').innerHTML = libraryDocs.map(d => {
    const safeTitle = d.title.replace(/'/g, "\\'");
    return `<div class="library-item">
      <div class="library-item-info">
        <div class="library-item-title">${d.title}</div>
        <div class="library-item-meta">${d.date} · ${d.type}</div>
      </div>
      <div class="library-item-actions">
        <button class="doc-action-btn" onclick="viewDoc('${safeTitle}')" title="View"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        <button class="doc-action-btn" onclick="addLibDoc('${safeTitle}','${d.type}')" title="Add to Workspace"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
      </div>
    </div>`;
  }).join('');
}
function addLibDoc(title, type) {
  documents.push({ id: Date.now(), title, type, date: 'Just now', parentId: null });
  workspaceDocs[currentWs.id] = documents;
  renderDocuments();
  renderSidebar();
  alert('Added "' + title + '" to ' + currentWs.name);
}
function renderPulse() {
  document.getElementById('pulseList').innerHTML = pulseArticles.map(t => {
    const safeT = t.replace(/'/g, "\\'");
    return `<div class="pulse-item" onclick="alert('Opening: ${safeT}')">
      <div class="pulse-item-title">${t}</div>
    </div>`;
  }).join('');
}

// CHAT
function updateChatUsage() {
  const usage = document.querySelector('.chat-usage');
  if (usage) usage.textContent = `${chatMessageCount}/${CHAT_LIMIT}`;
}

let isChatStreaming = false;

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || isChatStreaming) return;
  
  // Check message limit
  if (chatMessageCount >= CHAT_LIMIT) {
    const action = confirm(`You've reached the ${CHAT_LIMIT} message limit for this chat.\n\nClick OK to save/download this chat and start a new one, or Cancel to continue without sending.`);
    if (action) {
      // Offer save or download
      const saveChoice = confirm('Save to chat history?\n\nOK = Save to history\nCancel = Download as file');
      if (saveChoice) {
        saveChat();
      } else {
        downloadChat();
      }
      resetChat();
    }
    return;
  }
  
  chatIsSaved = false;
  const chat = document.getElementById('chatMessages');
  const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  
  // Add user message
  chat.innerHTML += `
    <div class="chat-message user">
      <div class="message-bubble">${escapeHtml(msg)}</div>
      <div class="message-footer">
        <span class="message-time">You · ${time}</span>
        <div class="message-actions">
          <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
        </div>
      </div>
    </div>`;
  
  chatMessages.push({ role: 'user', content: msg, time });
  chatMessageCount++;
  updateChatUsage();
  input.value = '';
  chat.scrollTop = chat.scrollHeight;
  
  // Check if we have live docs to search
  const hasLiveDocs = liveMode && documents.some(d => typeof d.id === 'string');
  
  if (hasLiveDocs) {
    await sendChatToAPI(msg, chat);
  } else {
    simulateChatResponse(chat);
  }
}

async function sendChatToAPI(msg, chatEl) {
  isChatStreaming = true;
  const sendBtn = document.getElementById('chatSend');
  if (sendBtn) sendBtn.disabled = true;

  // Show thinking indicator
  chatEl.innerHTML += `
    <div class="thinking-indicator" id="wsThinking">
      <div class="thinking-dots"><span></span><span></span><span></span></div>
      <span>Analyzing workspace documents...</span>
    </div>`;
  chatEl.scrollTop = chatEl.scrollHeight;

  try {
    // Build task with document IDs
    const liveDocs = documents.filter(d => typeof d.id === 'string');
    const docIds = liveDocs.map(d => d.id);
    const docNames = liveDocs.map(d => d.title).join(', ');
    
    console.log('Workspace chat context:', { 
      workspace: currentWs?.name,
      docCount: liveDocs.length, 
      docIds: docIds.slice(0, 3),
      msg 
    });
    
    let task = `WORKSPACE CONTEXT: Search these ${docIds.length} documents in the ${currentWs?.name || 'current'} workspace.\n`;
    task += `Documents: ${docNames}\n`;
    task += `Document IDs: ${docIds.join(', ')}\n\n`;
    task += `USER QUESTION: ${msg}`;

    const response = await api.executeDocChat(task);
    console.log('Chat API response:', response);

    if (response && response.runId && response.workflowId) {
      let gotAnswer = false;
      
      await api.streamResponse(response.workflowId, response.runId,
        (data) => {
          if (data.type === 'answer' && data.message && !gotAnswer) {
            const answer = api.extractAnswer(data.message);
            if (answer && answer.length > 10) {
              gotAnswer = true;
              document.getElementById('wsThinking')?.remove();
              addAIResponse(chatEl, answer);
            }
          }
        },
        () => {
          // onComplete
          if (!gotAnswer) {
            document.getElementById('wsThinking')?.remove();
            addAIResponse(chatEl, "I couldn't find relevant information in the workspace documents. Try rephrasing your question or checking that the documents contain the information you're looking for.");
          }
        },
        (error) => {
          // onError
          console.error('Stream error:', error);
          document.getElementById('wsThinking')?.remove();
          addAIResponse(chatEl, 'Sorry, there was an error processing your request. Please try again.');
        }
      );
    } else {
      throw new Error('No runId/workflowId in response');
    }
  } catch (error) {
    console.error('Chat API error:', error);
    document.getElementById('wsThinking')?.remove();
    addAIResponse(chatEl, 'Error connecting to AI. Please try again.');
  } finally {
    // CRITICAL: Always reset state
    console.log('Resetting chat state...');
    isChatStreaming = false;
    if (sendBtn) sendBtn.disabled = false;
  }
}

function addAIResponse(chatEl, text, sources = []) {
  const aiTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  let sourcesHtml = sources.length > 0 
    ? `<div class="message-sources">Sources: ${sources.map(s => `<a href="#" onclick="event.preventDefault();viewDoc('${s}')">${s}</a>`).join(', ')}</div>` 
    : '';
  
  chatEl.innerHTML += `
    <div class="chat-message ai">
      <div class="message-bubble">${formatAIResponse(text)}</div>
      ${sourcesHtml}
      <div class="message-footer">
        <span class="message-time">Scout · ${aiTime}</span>
        <div class="message-actions">
          <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
          <button class="msg-action-btn" onclick="quoteMessage(this)" title="Save Quote"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3"/></svg></button>
        </div>
      </div>
    </div>`;
  
  chatMessages.push({ role: 'ai', content: text, time: aiTime, sources });
  chatMessageCount++;
  updateChatUsage();
  chatEl.scrollTop = chatEl.scrollHeight;
}

function simulateChatResponse(chat) {
  setTimeout(() => {
    const responses = [
      { text: `Based on the ${documents.length} documents in this workspace, I can help analyze the topics covered. What specific aspect would you like to explore?`, sources: [] },
      { text: `Looking at the research in this workspace, there are several interconnected themes. The semiconductor supply chain analysis shows significant concentration risk, particularly around TSMC's dominance in advanced nodes.`, sources: ['TSMC Dependencies', 'Foundry Market Analysis'] },
      { text: `The documents suggest a few key risk factors to consider. Would you like me to summarize the main findings or dive deeper into a specific area?`, sources: ['Risk Modeling'] }
    ];
    const response = responses[Math.floor(Math.random() * responses.length)];
    addAIResponse(chat, response.text, response.sources);
  }, 1000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Format AI responses with proper markdown rendering
function formatAIResponse(text) {
  if (!text) return '';
  
  // First escape HTML
  let html = escapeHtml(text);
  
  // Convert **bold** to <strong> (do this first, before italic)
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  
  // Convert bullet points (- or •) at start of lines
  html = html.replace(/^[\-•]\s+(.+)$/gm, '<li>$1</li>');
  
  // Wrap consecutive <li> in <ul>
  html = html.replace(/(<li>[^<]*<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`);
  
  // Convert numbered lists (1. 2. etc)
  html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
  
  // Double newlines become paragraph breaks
  const paragraphs = html.split(/\n\n+/);
  html = paragraphs.map(para => {
    para = para.trim();
    if (!para) return '';
    // Don't wrap if already a list
    if (para.startsWith('<ul>') || para.startsWith('<li>')) return para;
    return `<p>${para.replace(/\n/g, '<br>')}</p>`;
  }).filter(p => p).join('');
  
  return html;
}

function newChat() {
  if (chatMessages.length > 0 && !chatIsSaved) {
    if (!confirm('Start a new chat?\n\nYour current conversation is not saved. Click "Save" first to keep it, or continue to discard.')) {
      return;
    }
  }
  
  // Reset streaming state
  isChatStreaming = false;
  const sendBtn = document.getElementById('chatSend');
  if (sendBtn) sendBtn.disabled = false;
  
  currentChatId = null;
  chatIsSaved = true;
  resetChat();
}

function saveChat() {
  if (chatMessages.length === 0) {
    alert('No messages to save.');
    return;
  }
  
  // Get first user message as default title
  const firstUserMsg = chatMessages.find(m => m.role === 'user');
  const defaultTitle = firstUserMsg ? firstUserMsg.content.substring(0, 40) + (firstUserMsg.content.length > 40 ? '...' : '') : 'Untitled Chat';
  
  const title = prompt('Name this conversation:', defaultTitle);
  if (!title) return;
  
  // Initialize workspace chats array if needed
  if (!workspaceChats[currentWs.id]) {
    workspaceChats[currentWs.id] = [];
  }
  
  const chatData = {
    id: currentChatId || 'chat_' + Date.now(),
    title: title,
    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
    messages: [...chatMessages]
  };
  
  // Update existing or add new
  if (currentChatId) {
    const idx = workspaceChats[currentWs.id].findIndex(c => c.id === currentChatId);
    if (idx >= 0) {
      workspaceChats[currentWs.id][idx] = chatData;
    } else {
      workspaceChats[currentWs.id].unshift(chatData);
    }
  } else {
    workspaceChats[currentWs.id].unshift(chatData);
    currentChatId = chatData.id;
  }
  
  chatIsSaved = true;
  renderChatHistory();
  saveWorkspaceChats(); // Persist to localStorage
  
  // Brief confirmation
  const btn = document.querySelector('[onclick="saveChat()"]');
  if (btn) {
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
    setTimeout(() => {
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
    }, 1500);
  }
}

// Chat History Popup
function toggleChatHistory(event) {
  event.stopPropagation();
  const popup = document.getElementById('chatHistoryPopup');
  popup.classList.toggle('open');
  if (popup.classList.contains('open')) {
    renderChatHistory();
  }
}

function closeChatHistory() {
  document.getElementById('chatHistoryPopup').classList.remove('open');
}

// Close popup when clicking outside
document.addEventListener('click', (e) => {
  const popup = document.getElementById('chatHistoryPopup');
  if (popup && popup.classList.contains('open') && !e.target.closest('.chat-history-popup') && !e.target.closest('[onclick*="toggleChatHistory"]')) {
    popup.classList.remove('open');
  }
});

function renderChatHistory() {
  const list = document.getElementById('chatHistoryList');
  if (!list) return;
  
  const chats = workspaceChats[currentWs.id] || [];
  
  if (chats.length === 0) {
    list.innerHTML = '<div class="chat-history-empty">No saved chats yet.<br>Save your current conversation to access it later.</div>';
    return;
  }
  
  list.innerHTML = chats.map(chat => `
    <div class="chat-history-item ${chat.id === currentChatId ? 'active' : ''}" data-chat-id="${chat.id}">
      <div class="chat-history-icon">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="chat-history-info" onclick="loadSavedChat('${chat.id}')">
        <div class="chat-history-name">${escapeHtml(chat.title)}</div>
        <div class="chat-history-meta">${chat.date} · ${chat.messages.length} messages</div>
      </div>
      <div class="chat-history-actions">
        <button class="chat-history-action" onclick="event.stopPropagation();renameSavedChat('${chat.id}')" title="Rename">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="chat-history-action danger" onclick="event.stopPropagation();deleteSavedChat('${chat.id}')" title="Delete">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
    </div>
  `).join('');
}

function loadSavedChat(chatId) {
  // Check if current chat needs saving
  if (chatMessages.length > 0 && !chatIsSaved && currentChatId !== chatId) {
    if (!confirm('Load saved chat?\n\nYour current conversation is not saved and will be lost.')) {
      return;
    }
  }
  
  const chats = workspaceChats[currentWs.id] || [];
  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  
  // Reset streaming state
  isChatStreaming = false;
  const sendBtn = document.getElementById('chatSend');
  if (sendBtn) sendBtn.disabled = false;
  
  currentChatId = chatId;
  chatMessages = [...chat.messages];
  chatMessageCount = chat.messages.length;
  chatIsSaved = true;
  
  // Render the loaded chat
  const container = document.getElementById('chatMessages');
  container.innerHTML = chatMessages.map(msg => {
    if (msg.role === 'user') {
      return `
        <div class="chat-message user">
          <div class="message-bubble">${escapeHtml(msg.content)}</div>
          <div class="message-footer">
            <span class="message-time">You · ${msg.time}</span>
            <div class="message-actions">
              <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
            </div>
          </div>
        </div>`;
    } else {
      let sourcesHtml = '';
      if (msg.sources && msg.sources.length > 0) {
        sourcesHtml = `<div class="message-sources">Sources: ${msg.sources.map(s => `<a href="#" onclick="event.preventDefault();viewDoc('${s}')">${s}</a>`).join(', ')}</div>`;
      }
      return `
        <div class="chat-message ai">
          <div class="message-bubble">${msg.content}</div>
          ${sourcesHtml}
          <div class="message-footer">
            <span class="message-time">Scout · ${msg.time}</span>
            <div class="message-actions">
              <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
              <button class="msg-action-btn" onclick="quoteMessage(this)" title="Save Quote"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3"/></svg></button>
            </div>
          </div>
        </div>`;
    }
  }).join('');
  
  updateChatUsage();
  renderChatHistory();
  closeChatHistory();
  container.scrollTop = container.scrollHeight;
}

function renameSavedChat(chatId) {
  const chats = workspaceChats[currentWs.id] || [];
  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  
  const newTitle = prompt('Rename conversation:', chat.title);
  if (!newTitle || newTitle === chat.title) return;
  
  chat.title = newTitle;
  renderChatHistory();
  saveWorkspaceChats(); // Persist to localStorage
}

function deleteSavedChat(chatId) {
  if (!confirm('Delete this saved conversation?')) return;
  
  workspaceChats[currentWs.id] = (workspaceChats[currentWs.id] || []).filter(c => c.id !== chatId);
  
  // If we deleted the current chat, reset
  if (currentChatId === chatId) {
    currentChatId = null;
    chatIsSaved = true;
  }
  
  renderChatHistory();
  saveWorkspaceChats(); // Persist to localStorage
}

function downloadChat() {
  if (chatMessages.length === 0) {
    alert('No messages to download.');
    return;
  }
  
  let markdown = `# Workspace Chat: ${currentWs.name}\n`;
  markdown += `Downloaded: ${new Date().toLocaleString()}\n\n---\n\n`;
  
  chatMessages.forEach(msg => {
    const role = msg.role === 'user' ? '**You**' : '**Scout**';
    markdown += `${role} (${msg.time}):\n${msg.content}\n`;
    if (msg.sources && msg.sources.length > 0) {
      markdown += `*Sources: ${msg.sources.join(', ')}*\n`;
    }
    markdown += '\n---\n\n';
  });
  
  const blob = new Blob([markdown], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat-${currentWs.name.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.md`;
  a.click();
  URL.revokeObjectURL(url);
}

function copyMessage(btn) {
  const bubble = btn.closest('.chat-message').querySelector('.message-bubble');
  const text = bubble.textContent || bubble.innerText;
  
  navigator.clipboard.writeText(text).then(() => {
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
    setTimeout(() => { btn.innerHTML = originalHtml; }, 1500);
  });
}

function quoteMessage(btn) {
  const bubble = btn.closest('.chat-message').querySelector('.message-bubble');
  const text = bubble.textContent || bubble.innerText;
  
  // For demo, just show confirmation
  // In real implementation, this would save to a quotes collection
  const preview = text.length > 100 ? text.substring(0, 100) + '...' : text;
  alert(`Quote saved:\n\n"${preview}"`);
}

// ===== DOCUMENT VIEWER =====
let currentViewDoc = null;
let currentViewContent = '';
let docChatMessages = [];

// Sample document content for demo
const sampleDocuments = {
  'Semiconductor Ecosystem: TSMC Dependencies': `# Semiconductor Ecosystem: TSMC Dependencies

## Executive Summary

This analysis examines Taiwan Semiconductor Manufacturing Company's (TSMC) dominant position in the global semiconductor supply chain and the systemic risks this concentration creates for technology companies and investors.

## Key Findings

### Market Position
TSMC controls approximately **54% of global foundry market share** and over **90% of advanced node production** (7nm and below). This concentration creates significant supply chain vulnerabilities for companies dependent on cutting-edge chips.

### Customer Exposure
- **Apple**: Sources 100% of A-series and M-series chips from TSMC
- **NVIDIA**: 85%+ of GPU production at TSMC
- **AMD**: Complete reliance on TSMC for CPU and GPU production
- **Qualcomm**: Primary foundry partner for Snapdragon processors

### Geopolitical Risk Factors
Taiwan's proximity to China creates material geopolitical risk. A disruption to TSMC operations could:
- Remove 54% of global foundry capacity
- Create 12-18 month lead times for alternative supply
- Impact $500B+ in downstream technology revenue

## Risk Assessment

| Factor | Risk Level | Mitigation Available |
|--------|-----------|---------------------|
| Single source dependency | Critical | Limited |
| Geopolitical exposure | High | Moderate |
| Capacity constraints | Medium | Improving |
| Technology leadership | Low | Strong |

## Investment Implications

Investors should consider:
1. Diversification of semiconductor exposure
2. Monitoring of cross-strait relations
3. Alternative foundry capacity buildout (Intel, Samsung)
4. Supply chain resilience in portfolio companies

## Conclusion

TSMC's dominance creates both opportunity and systemic risk. Portfolio positioning should account for potential disruption scenarios while recognizing TSMC's technological moat.`,

  'Competitive Dynamics: Foundry Market': `# Competitive Dynamics: Foundry Market Analysis

## Executive Summary

A Porter's Five Forces analysis of the semiconductor foundry market reveals high barriers to entry, significant supplier power, and intensifying competitive dynamics among established players.

## Porter's Five Forces Analysis

### Threat of New Entrants: LOW
- **Capital requirements**: $20B+ for leading-edge fab
- **Technology barriers**: 5+ years to reach competitive node
- **Talent scarcity**: Limited pool of advanced process engineers
- **Customer relationships**: Long qualification cycles (12-24 months)

### Supplier Power: MODERATE-HIGH
- **ASML monopoly**: Sole supplier of EUV lithography
- **Materials concentration**: Specialty chemicals and gases
- **Equipment lead times**: 18-24 months for critical tools

### Buyer Power: LOW-MODERATE
- **Switching costs**: High due to design integration
- **Capacity scarcity**: Demand exceeds supply at leading edge
- **Alternative options**: Limited for advanced nodes

### Threat of Substitutes: LOW
- **No viable alternatives** for advanced semiconductor manufacturing
- **Chiplets and packaging** complement rather than substitute

### Competitive Rivalry: HIGH
- **TSMC**: Technology leader, 54% share
- **Samsung**: Aggressive capacity expansion, yield challenges
- **Intel Foundry**: Re-entering market, significant investment

## Strategic Implications

The foundry market structure favors incumbents with scale and technology leadership. TSMC's position is defensible but not unassailable as competitors invest heavily in capacity and capability.`,

  'ASML Equipment Dependency Analysis': `# ASML Equipment Dependency Analysis

## Overview

This deep-dive analysis examines the critical role of ASML in the semiconductor supply chain as the sole provider of extreme ultraviolet (EUV) lithography systems.

## ASML's Monopoly Position

### Technology Leadership
ASML is the **only company** capable of producing EUV lithography machines, which are essential for manufacturing chips at 7nm and below. This creates an unprecedented single point of failure in the semiconductor supply chain.

### Equipment Economics
- **Cost per system**: $150-200 million
- **Annual production capacity**: ~50-60 systems
- **Lead time**: 18-24 months
- **Installation and calibration**: 6+ months

## Customer Dependencies

All leading-edge foundries depend entirely on ASML:

| Customer | EUV Systems | Capacity Plans |
|----------|-------------|----------------|
| TSMC | 100+ | Expanding aggressively |
| Samsung | 30+ | Ramping for GAA |
| Intel | 20+ | Catching up |

## Risk Analysis

### Supply Chain Vulnerabilities
1. **Single source**: No alternative EUV supplier exists
2. **Component complexity**: 100,000+ parts from 5,000 suppliers
3. **Export restrictions**: Geopolitical exposure to controls
4. **Production bottleneck**: Demand exceeds manufacturing capacity

### Mitigation Considerations
- ASML expanding production in Netherlands and Connecticut
- Development of High-NA EUV for next generation
- Some chipmakers exploring non-EUV alternatives for certain applications

## Investment Thesis

ASML represents both a strategic bottleneck and an investable moat. The company's position is secure for the foreseeable future, though geopolitical factors warrant monitoring.`
};

let currentViewDocId = null; // Track doc ID for API calls

function viewDoc(title) {
  // Check if we have this doc in live data
  if (liveMode) {
    const liveDoc = allVertesiaDocs.find(d => d.title === title);
    if (liveDoc && liveDoc.source) {
      viewDocFromAPI(liveDoc);
      return;
    }
  }
  
  // Fallback to demo content
  const content = sampleDocuments[title] || generatePlaceholderDoc(title);
  openDocViewer(content, title);
}

async function viewDocFromAPI(doc) {
  currentViewDoc = doc.title;
  currentViewDocId = doc.id;
  currentViewContent = '';
  docChatMessages = [];

  const dialog = document.getElementById('docViewer');
  document.getElementById('docViewerTitle').textContent = doc.title;
  document.getElementById('docChatTitle').textContent = doc.title;
  document.getElementById('viewerParentDocName').textContent = doc.title;
  document.getElementById('docBody').innerHTML = `
    <div style="text-align:center;padding:60px;color:var(--muted)">
      <div class="loading-spinner" style="margin:0 auto 16px;width:32px;height:32px;border-width:2px"></div>
      <p>Loading document...</p>
    </div>`;
  document.getElementById('docTocList').innerHTML = '';
  document.getElementById('docViewerContainer').classList.remove('chat-open');
  document.getElementById('docChatToggle').classList.remove('active');
  
  // Reset chat UI
  document.getElementById('docChatMessages').innerHTML = `
    <div class="doc-chat-empty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <p>Ask questions about this document</p>
    </div>`;
  document.getElementById('docFollowupContext').value = '';
  switchDocTab('chat');
  
  dialog.showModal();

  try {
    console.log('Loading document content from:', doc.source);
    const content = await api.getFileContent(doc.source);
    currentViewContent = content;
    
    // Use marked.js for proper rendering
    if (typeof marked !== 'undefined') {
      document.getElementById('docBody').innerHTML = marked.parse(content);
    } else {
      renderDocContent(content);
    }
    renderDocTOC(content);
  } catch (error) {
    console.error('Failed to load document:', error);
    document.getElementById('docBody').innerHTML = `
      <div style="text-align:center;padding:60px;color:var(--danger)">
        <p style="font-size:18px;margin-bottom:8px">Failed to load document</p>
        <p style="font-size:13px">${error.message}</p>
      </div>`;
  }
}

function generatePlaceholderDoc(title) {
  return `# ${title}

## Overview

This document provides analysis related to the ${currentWs?.name || 'current workspace'} research theme.

## Key Points

- Analysis point one with relevant findings
- Analysis point two with supporting data
- Analysis point three with implications

## Methodology

The research was conducted using a combination of quantitative analysis and qualitative assessment, drawing on multiple data sources and expert perspectives.

## Conclusions

Further analysis is recommended to explore the implications identified in this document.

---
*Generated document placeholder for demo purposes*`;
}

function openDocViewer(content, title) {
  currentViewDoc = title;
  currentViewDocId = null; // Reset for demo docs
  currentViewContent = content;
  docChatMessages = [];
  
  const dialog = document.getElementById('docViewer');
  const titleEl = document.getElementById('docViewerTitle');
  const chatTitleEl = document.getElementById('docChatTitle');
  const container = document.getElementById('docViewerContainer');
  const toggle = document.getElementById('docChatToggle');
  
  titleEl.textContent = title;
  chatTitleEl.textContent = title;
  container.classList.remove('chat-open');
  toggle.classList.remove('active');
  
  // Render TOC and content
  renderDocTOC(content);
  
  // Use marked.js for proper rendering if available
  if (typeof marked !== 'undefined') {
    document.getElementById('docBody').innerHTML = marked.parse(content);
  } else {
    renderDocContent(content);
  }
  
  // Reset chat
  document.getElementById('docChatMessages').innerHTML = `
    <div class="doc-chat-empty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <p>Ask questions about this document to get deeper insights</p>
    </div>`;
  
  // Reset follow-up and set parent document display
  document.getElementById('docFollowupContext').value = '';
  document.getElementById('viewerParentDocName').textContent = title;
  switchDocTab('chat');
  
  dialog.showModal();
  
  console.log('Opened doc viewer:', { title, hasLiveId: !!currentViewDocId, liveMode });
}

function renderDocTOC(markdown) {
  const tocList = document.getElementById('docTocList');
  const headings = [];
  const lines = markdown.split('\n');
  
  lines.forEach(line => {
    const match = line.match(/^(#{1,3})\s+(.+)$/);
    if (match) {
      const level = match[1].length;
      const text = match[2].trim();
      const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      headings.push({ level, text, id });
    }
  });
  
  if (headings.length === 0) {
    tocList.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:12px;">No sections found</div>';
    return;
  }
  
  tocList.innerHTML = headings.map(h => `
    <div class="doc-toc-item level-${h.level}" data-target="${h.id}" onclick="scrollToSection('${h.id}')">
      ${h.text}
    </div>
  `).join('');
}

function renderDocContent(markdown) {
  const body = document.getElementById('docBody');
  
  // Simple markdown to HTML conversion
  let html = markdown
    // Headers with IDs
    .replace(/^### (.+)$/gm, (_, text) => `<h3 id="${text.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${text}</h3>`)
    .replace(/^## (.+)$/gm, (_, text) => `<h2 id="${text.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${text}</h2>`)
    .replace(/^# (.+)$/gm, (_, text) => `<h1 id="${text.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${text}</h1>`)
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Lists
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
    // Paragraphs
    .split('\n\n').map(p => {
      if (p.startsWith('<h') || p.startsWith('<li') || p.startsWith('<table') || p.startsWith('|')) return p;
      if (p.includes('<li>')) return `<ul>${p}</ul>`;
      if (p.trim() === '---') return '<hr>';
      return `<p>${p.replace(/\n/g, '<br>')}</p>`;
    }).join('\n')
    // Tables (simple)
    .replace(/\|(.+)\|/g, (match) => {
      const cells = match.split('|').filter(c => c.trim());
      if (cells.every(c => c.match(/^[\s-:]+$/))) return ''; // Skip separator row
      const isHeader = cells[0] && !match.includes('---');
      const tag = isHeader ? 'th' : 'td';
      return `<tr>${cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('')}</tr>`;
    });
  
  // Wrap table rows
  html = html.replace(/(<tr>.*?<\/tr>\s*)+/g, '<table>$&</table>');
  
  body.innerHTML = html;
}

function scrollToSection(id) {
  const target = document.getElementById(id);
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Update active TOC item
    document.querySelectorAll('.doc-toc-item').forEach(item => {
      item.classList.toggle('active', item.dataset.target === id);
    });
  }
}

function toggleDocChat() {
  const container = document.getElementById('docViewerContainer');
  const toggle = document.getElementById('docChatToggle');
  
  container.classList.toggle('chat-open');
  toggle.classList.toggle('active');
}

function switchDocTab(tab) {
  document.querySelectorAll('.doc-panel-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
  });
  document.getElementById('docChatTab').classList.toggle('hidden', tab !== 'chat');
  document.getElementById('docFollowupTab').classList.toggle('hidden', tab !== 'followup');
}

let isDocChatStreaming = false;

async function sendDocChat() {
  const input = document.getElementById('docChatInput');
  const msg = input.value.trim();
  if (!msg || isDocChatStreaming) return;
  
  console.log('sendDocChat called:', { msg, liveMode, currentViewDocId, currentViewDoc });
  
  const messagesEl = document.getElementById('docChatMessages');
  const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  
  // Clear empty state if first message
  if (docChatMessages.length === 0) {
    messagesEl.innerHTML = '';
  }
  
  // Add user message
  messagesEl.innerHTML += `
    <div class="doc-chat-message user">
      <div class="doc-chat-bubble">${escapeHtml(msg)}</div>
      <div class="doc-chat-time">You · ${time}</div>
    </div>`;
  
  docChatMessages.push({ role: 'user', content: msg, time });
  input.value = '';
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  // Use API if we have a live doc ID
  if (liveMode && currentViewDocId) {
    console.log('Using API for doc chat');
    await sendDocChatToAPI(msg, messagesEl);
  } else {
    console.log('Using demo mode for doc chat');
    simulateDocChatResponse(messagesEl);
  }
}

async function sendDocChatToAPI(msg, messagesEl) {
  isDocChatStreaming = true;
  const sendBtn = document.getElementById('docChatSend');
  if (sendBtn) sendBtn.disabled = true;
  
  // Show thinking indicator
  messagesEl.innerHTML += `
    <div class="thinking-indicator" id="docThinking">
      <div class="thinking-dots"><span></span><span></span><span></span></div>
      <span>Analyzing document...</span>
    </div>`;
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try {
    const task = `DOCUMENT CONTEXT: Analyze document ID ${currentViewDocId} (${currentViewDoc})\n\nUSER QUESTION: ${msg}`;
    
    console.log('Sending doc chat:', { docId: currentViewDocId, msg });
    const response = await api.executeDocChat(task);
    console.log('Doc chat response:', response);

    if (response && response.runId && response.workflowId) {
      let gotAnswer = false;
      
      await api.streamResponse(response.workflowId, response.runId,
        (data) => {
          if (data.type === 'answer' && data.message && !gotAnswer) {
            const answer = api.extractAnswer(data.message);
            if (answer && answer.length > 10) {
              gotAnswer = true;
              document.getElementById('docThinking')?.remove();
              addDocAIResponse(messagesEl, answer);
            }
          }
        },
        () => {
          // onComplete
          if (!gotAnswer) {
            document.getElementById('docThinking')?.remove();
            addDocAIResponse(messagesEl, "I couldn't find relevant information in this document for your question.");
          }
        },
        (error) => {
          // onError
          console.error('Doc chat stream error:', error);
          document.getElementById('docThinking')?.remove();
          addDocAIResponse(messagesEl, 'Error processing your request. Please try again.');
        }
      );
    } else {
      throw new Error('No runId/workflowId');
    }
  } catch (error) {
    console.error('Doc chat error:', error);
    document.getElementById('docThinking')?.remove();
    addDocAIResponse(messagesEl, 'Error connecting to AI. Please try again.');
  } finally {
    // CRITICAL: Always reset state
    console.log('Resetting doc chat state...');
    isDocChatStreaming = false;
    if (sendBtn) sendBtn.disabled = false;
  }
}

function addDocAIResponse(messagesEl, text) {
  const aiTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  messagesEl.innerHTML += `
    <div class="doc-chat-message assistant">
      <div class="doc-chat-bubble">${formatAIResponse(text)}</div>
      <div class="doc-chat-time">Scout · ${aiTime}</div>
    </div>`;
  docChatMessages.push({ role: 'assistant', content: text, time: aiTime });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function simulateDocChatResponse(messagesEl) {
  setTimeout(() => {
    const responses = [
      `Based on this document, the key finding is the significant concentration risk in the semiconductor supply chain. TSMC's dominant position creates both investment opportunity and systemic vulnerability.`,
      `The document highlights several critical dependencies. Would you like me to elaborate on any specific aspect - the customer exposure, geopolitical risks, or investment implications?`,
      `Looking at the analysis, the most actionable insight is around supply chain diversification. The document suggests monitoring alternative foundry capacity from Intel and Samsung.`
    ];
    addDocAIResponse(messagesEl, responses[Math.floor(Math.random() * responses.length)]);
  }, 1000);
}

function closeDocViewer() {
  const dialog = document.getElementById('docViewer');
  dialog.close();
  currentViewDoc = null;
  currentViewContent = '';
}

function downloadDocPDF() {
  if (!currentViewContent) return;
  
  // Create print window
  const printWindow = window.open('', '_blank');
  if (!printWindow) {
    alert('Pop-up blocked. Please allow pop-ups and try again.');
    return;
  }
  
  const html = document.getElementById('docBody').innerHTML;
  
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${currentViewDoc}</title>
      <style>
        @media print { @page { margin: 0.5in; } }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; color: #1f2d3d; max-width: 800px; margin: 0 auto; padding: 30px; }
        h1 { font-size: 24px; color: #172A3A; border-bottom: 2px solid #4a9da8; padding-bottom: 10px; margin: 24px 0 16px; }
        h2 { font-size: 18px; margin: 20px 0 12px; border-left: 3px solid #4a9da8; padding-left: 12px; }
        h3 { font-size: 15px; margin: 16px 0 10px; }
        p { margin-bottom: 12px; }
        strong { color: #172A3A; }
        table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
        th { background: #172A3A; color: white; padding: 8px 10px; text-align: left; }
        td { border: 1px solid #e0e5ea; padding: 8px 10px; }
        ul, ol { margin: 12px 0; padding-left: 24px; }
        li { margin-bottom: 6px; }
      </style>
    </head>
    <body>${html}</body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.onload = () => {
    setTimeout(() => {
      printWindow.print();
      setTimeout(() => printWindow.close(), 100);
    }, 250);
  };
}

async function generateFollowUp() {
  const context = document.getElementById('docFollowupContext').value.trim();
  const scope = document.getElementById('docFollowupScope').value || 'Asset';
  const rigor = document.getElementById('docFollowupRigor').value || 'In Depth';
  
  // Save doc info before closing viewer
  const parentDocTitle = currentViewDoc;
  const parentDocId = currentViewDocId || currentViewDoc;
  
  if (!parentDocId) {
    alert('No document selected for follow-up');
    return;
  }
  
  // Build prompt directly
  const prompt = `FOLLOW-UP RESEARCH REQUEST

First, access and analyze Document ID: ${parentDocId} from the content object library.
Parent document: ${parentDocTitle}
IMPORTANT: When creating the output document, set the parent metadata to reference document ID: ${parentDocId}

Research Direction: ${context || 'Further analysis based on the parent document'}

Research Parameters:
- Scope: ${scope}
- Analytical Rigor: ${rigor}

Use insights from the parent document to enhance this research.
Generate a comprehensive research document with hyperlinked sources.
The final output must be a document uploaded to the content object library.
`;

  const jobName = `Follow-up: ${parentDocTitle.substring(0, 30)}${parentDocTitle.length > 30 ? '...' : ''}`;
  
  console.log('Starting follow-up research:', { parentDocId, parentDocTitle, scope, rigor, context });
  
  // Close viewer first
  closeDocViewer();
  
  // Call API if in live mode
  if (liveMode) {
    try {
      const response = await api.executeResearch(prompt);
      console.log('Follow-up research started:', response);
      
      addJob(jobName, true);
      
      if (response.runId && response.workflowId) {
        pollResearchCompletion(response.workflowId, response.runId, jobName);
      }
    } catch (error) {
      console.error('Failed to start follow-up research:', error);
      alert('Failed to start follow-up research. Please try again.');
      return;
    }
  } else {
    addJob(jobName, false);
  }
}
</script>
</body>
</html>
